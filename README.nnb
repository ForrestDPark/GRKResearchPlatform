{
    "cells": [
        {
            "language": "markdown",
            "source": [
                "# ì„¤ì¹˜ ë° ê¸°ë³¸ ì„¸íŒ… í”Œë¡œìš° \n```Bash\n## ë””ë ‰í† ë¦¬ ìƒì„± \ncd GRKResearchPlatform\ncd grk \n\n\nvi tsconfig.json\n################################\n{\n    \"compilerOptions\": {\n        \"module\": \"CommonJS\",\n        \"target\": \"ESNEXT\",\n        \"experimentalDecorators\":true,\n        \"emitDecoratorMetadata\":true\n    }\n}\n################################\ncd grk\n## npm ì¸ìŠ¤í†¨ \nnpm install\n\n## NestJS + typescript  setting\nnpm install  -g @nestjs/cli\nnpm i @nestjs/core @nestjs/common @nestjs/platform-express reflect-metadata typescript\nnpm i -g typescript ts-node\n\n## console beautify\nnpm install chalk\n\n## Mongo DB \nnpm install mongodb\nnpm install @nestjs/mongoose mongoose\n\n## Sqlite & typeORM\nnpm install sqlite3 typeorm @nestjs/typeorm\n\n## í•¸ë“¤ë°” UI\nnpm i express-handlebars@6.0.3\n\n### Config í™˜ê²½ë³€ìˆ˜  íŒ¨í‚¤ì§€\nnpm i @nestjs/config\n\n## yaml ì„¤ì¹˜ \nnpm i js-yaml\nnpm i -D @types/js-yaml\n\n## ë¹„ë°€ë²ˆí˜¸ hash ì•”í˜¸í™” íŒ¨í‚¤ì§€ \nnpm install class-validator class-transformer\nnpm install bcrypt\nnpm install -D @types/bcrypt \n\n## cookie parser ì„¤ì¹˜ \nnpm install cookie-parser\n\n## session and passport ì„¤ì¹˜ \nnpm i @nestjs/passport passport passport-local express-session\nnpm i -D @types/passport-local @types/express-session \n\n## google oauth \nnpm i passport-google-oauth20\nnpm i -D @types/passport-google-oauth20 \n\n\n## ì„œë²„ ê°œë°œì ëª¨ë“œ ì‹¤í–‰ \nnpm run start:dev\n\n\n```\n### (1) envs folder (config.yml, dev.env,local.env, prod.env)ìƒì„± \n### 2) package.json > strat ìˆ˜ì •\n```JSON\n    \"start\": \"NODE_ENV=local nest start\",\n    \"start:dev\": \"NODE_ENV=dev nest start --watch\",\n    \"start:debug\": \"nest start --debug --watch\",\n    \"start:prod\": \"NODE_ENV=prod&& node dist/main\",\n```\n### 3) src/configs/config.ts, common.ts, dev.ts, local.ts, prod.ts) ìƒì„± \n\n### 4) app.controller.ts, app.module.ts ìƒì„± \n\n### 5) configs í´ë” ë³µì‚¬ dev.ts ì •ë¦¬ \n\n### 6) project, task, user í´ë” ìƒì„± ê°ê° controller.model.repository,schema,service ìƒì„± í›„ app.module ì—ì„œ í•„ìš”í•œ import ì„¤ì • ì¶”ê°€, provider ì¶”ê°€ \n\n### 7) TypeORM ì¶”ê°€ RDB ì „í™˜ìš© ë¼ì´ë¸”ëŸ¬ë¦¬)\n\n\n\n"
            ],
            "outputs": []
        },
        {
            "language": "markdown",
            "source": [
                "# chapter 10 ë¡œê·¸ì¸ íšŒì›ê°€ì… ì¸ì¦ 1ë‹¨ê³„\n\n- Authenticationì¸ì¦) : ëˆ„êµ¬ì¸ì§€ í™•ì¸ \n- Authorization(ì¸ê°€) : ì¸ì¦ëœ ì‚¬ìš©ìì˜ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì ˆì°¨\n- ì¿ í‚¤, ì„¸ì…˜ì„ ì‚¬ìš©í•œ ì¸ì¦ ê¸°ëŠ¥ êµ¬í˜„ \n- NestJS ì—ì„œëŠ” ë¡¤ê¸°ë°˜ì˜ ê¶Œí•œ ê´€ë¦¬ ì œê³µ \n- https://docs.nestjs.com/security/authorization \n\n>chapter 10 ë¶€í„° grk platform ìœ¼ë¡œ ê°œë°œì„ í•˜ë„ë¡ í•˜ì. \ní–¥í›„  ch 9, 8 ì„ review í•˜ë©´ì„œ ë‹¤ì‹œ grk ë§Œë“¤ê²ƒ. \n\n- AuthModule, AuthController, AuthService í´ë˜ìŠ¤ë¡œ êµ¬ì„± \n- UserService ì—ëŠ” íšŒì›ì •ë³´ ì¶”ê°€,ìˆ˜ì •,ì‚­ì œ ë“±ì˜ method ìˆìŒ. \n  \n## 10.1.2 User module ìƒì„±\n\n```bash\n\nnest new grk\ncd grk \nnest g module user\nnest g controller user --no-spec \nnest g service user --no-spec\nnpm install sqlite3 typeorm @nestjs/typeorm\n\n# nest g module project\n\nnest g controller project --no-spec \nnest g service project --no-spec\n## ê¸°ì¡´ì˜ task,user,project í´ë” ì™€ ê°™ì´ íŒŒì¼ ë§Œë“ í›„ appmodule ì—ì„œ ì„¤ì •ì„ ìˆ˜ì •í• ê²ƒ \n\n\nnpm install @nestjs/mongoose mongoose\n\nnpm install class-validator class-transformer\n\n## ìœ ì € ì¸ì¦ \nnpm install bcrypt\nnpm install -D\n\n```\n### 10.2.1 ì—”í‹°í‹° ìƒì„±\n```TS\nimport { Column, Entity, PrimaryGeneratedColumn} from 'typeorm'\n@Entity()\nexport class User {\n    @PrimaryGeneratedColumn()\n    id? : number\n\n    @Column({ unique: true})\n    email : string \n\n    @Column()\n    password: string\n\n    @Column()\n    username: string\n\n    @Column()\n    role: string\n\n    @Column({ type: \"datetime\", default: () => \"CURRENT_TIMESTAMP\"})\n    createdDt: Date= new Date()\n}\n```\n# ğŸ¤”TypeORM ì´ë€\n\nNode.js í™˜ê²½ì—ì„œ TypeScript ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ”ë° ì‚¬ìš©ë˜ëŠ” Object-Relational Mapping(ORM) ë¼ì´ë¸ŒëŸ¬ë¦¬ì„. \nê°ì²´ì™€ ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ì˜ í…Œì´ë¸” ì‚¬ì´ì˜ ë¶ˆì¼ì¹˜ë¥¼ í•´ê²°í•´ ì£¼ëŠ” ì—­í• ì„ í•¨. \nê°œë°œìê°€ ë°ì´í„° ë² ì´ìŠ¤ì˜ ë³µì¡í•œ SQL ì¿¼ë¦¬ë¥¼ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³ ë„ ê°ì²´ ì§€í–¥ì ì¸ ì½”ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°ì‘í• ìˆ˜ ìˆê²Œ í•¨. \n- MySQL, PostgreSQL, SQLite, Oracle ë“±ì„ ì§€ì›í•¨. \n- ë°ì´í„° í…Œì´ë¸”ê³¼ ë§¤í•‘ \n- @Entity(), @Column(), @PrimaryGeneratedColum() ë“±ì˜ ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë˜ìŠ¤ ì†ì„±ì„ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ ì—°ê²°í•¨. \n- sql ì¿¼ë¦¬ë¬¸ì„ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šê³ ë„ ê°ì²´ë¥¼ í†µí•´ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì¡°ì‘ê°€ëŠ¥. \n- ë°ì´í„° ì €ì¥: repository.save(entity)\n- ë°ì´í„° ì¡°íšŒ : repository.find() , findOne() ì‚¬ìš© \n- ê´€ê³„ì„¤ì • ê°€ëŠ¥ \n    @OneToOne(), @OneToMany(), @ManyToMany() ë¡œ í…Œì´ë¸” ê°„ ê´€ê³„ ì •ì˜ ê°€ëŠ¥\n\n\n\n| ê¸°ëŠ¥             | `TypeOrmModule.forRoot()`                                                                                                 | `TypeOrmModule.forFeature()`                                                                                              |\n| :--------------- | :------------------------------------------------------------------------------------------------------------------------ | :----------------------------------------------------------------------------------------------------------------------- |\n| **ì—­í• **         | ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„¤ì • ë° ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì • ì •ì˜                                                                        | íŠ¹ì • ëª¨ë“ˆì—ì„œ ì‚¬ìš©í•  ì—”í‹°í‹° ë“±ë¡ ë° í•´ë‹¹ ëª¨ë“ˆì—ì„œ `Repository` ì‚¬ìš©                                                              |\n| **ì‚¬ìš© ìœ„ì¹˜**      | `AppModule` ë˜ëŠ” `CoreModule`ê³¼ ê°™ì€ ìµœìƒìœ„ ëª¨ë“ˆì—ì„œ í•œ ë²ˆë§Œ ì‚¬ìš©                                                                 | `UserModule`, `ProductModule`ê³¼ ê°™ì€ íŠ¹ì • ê¸°ëŠ¥ ëª¨ë“ˆì—ì„œ í•„ìš”ì— ë”°ë¼ ì‚¬ìš©                                                            |\n| **ê¸°ëŠ¥**          | ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°, ì—”í‹°í‹° ìë™ ë¡œë”©, ë™ê¸°í™”, ë§ˆì´ê·¸ë ˆì´ì…˜, ì»¤ë„¥ì…˜ í’€ ê´€ë¦¬, ì „ì²´ ì„¤ì • ê³µìœ                                                                | ì—”í‹°í‹° ë“±ë¡, ì˜ì¡´ì„± ì£¼ì… ì§€ì›, ëª¨ë“ˆ ìŠ¤ì½”í”„                                                                                 |\n| **ì˜í–¥ ë²”ìœ„**    | ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´                                                                                                          | íŠ¹ì • ëª¨ë“ˆ ë‚´                                                                                                             |\n| **ì‚¬ìš© ë¹ˆë„**     | ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í•œ ë²ˆë§Œ ì‚¬ìš©                                                                                                | ì—¬ëŸ¬ ëª¨ë“ˆì—ì„œ í•„ìš”ì— ë”°ë¼ ì‚¬ìš©                                                                                              |\n\n### (2) ì—”í„°í‹°ë¥¼ ì ìš©í•  ìœ ì €ì„œë¹„ìŠ¤ ìƒì„± (ê¸°ëŠ¥ì—†ìŒ)\n\n```TS\n//src/user/user.service.ts\n//User dto import\nimport { UserDto } from './user.model'\n\n// mogodb ìš© repository import \nimport { UserFileRepository, UserMongoRepository, UserRepository} from './user.repository'\n\n// ì˜ì¡´ì„± ì£¼ì… ê¸°ëŠ¥ import\nimport { Injectable } from '@nestjs/common'\n\n/* RDB ì„¤ì • ,typeORM */\nimport { InjectRepository } from '@nestjs/typeorm'\nimport { Repository } from 'typeorm'\nimport { User } from './user.entity'\nimport { ConfigService } from '@nestjs/config'\n\n@Injectable()\nexport class UserService {\n    constructor(\n        @InjectRepository(User) private userRepository: Repository<User>\n    ) {}\n    \n```\n- repository ë¥¼ ì˜ì¡´í•˜ì§€ ì•Šê³  service ë‹¨ì—ì„œ db ë¥¼ ì²˜ë¦¬ í•œë‹¤. \n\n|ë©”ì„œë“œ|ì„¤ëª…|\n|--|--|\n|find|SQL ì—ì„œ select ì™€ ê°™ì€ ì—­í•  <br> |\n|findOne|findOne(id?:string |\n|findAndCount|ì°¾ê³  ê°œìˆ˜ì„¸ê¸° |\n|create|ìƒì„±|\n|update|ìˆ˜ì •|\n|save|ì—†ìœ¼ë©´ ìƒì„± ìˆìœ¼ë©´ ìˆ˜ì •|\n|delete|ì—”í„°í‹° ë‚´ ë°ì´í„° ì‚­ì œ|\n|remove|ì—”í„°í‹° ì‚­ì œ |\n\n## 10.2.2 ì»¨íŠ¸ë¡¤ëŸ¬ \n\nservice ë¥¼ ì˜ì¡´í•´ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•¨. \n```TS\n// src/blog.controller.ts\n/* 1.  ë°ì½”ë ˆì´í„° í•¨ìˆ˜ ì„í¬íŠ¸ */\nimport {  Controller, Param,Body, Delete, Get, Post, Put} from '@nestjs/common'\n// ë¸”ë¡œê·¸ ì„œë¹„ìŠ¤ ì„í¬íŠ¸ \nimport { UserService } from './user.service'\n\n// SQLite setting \nimport { User } from './user.entity'\n\n@Controller('user') \nexport class UserController {\n  constructor(private userService: UserService) {}\n\n  @Post('/create') \n  createUser(@Body() user: User) {\n    return this.userService.createUser(user)\n  }\n  @Get('/getUser/:email')\n  async getUser(@Param('email') email: string) {\n    const user = await this.userService.getUser(email)\n    console.log(user)\n    return user \n  }\n  @Put('/update/:email')\n  updateUser(@Param('email') email:string, @Body() user: User) {\n    console.log(user)\n    return this.userService.updateUser(email,user)\n  }\n  @Delete('/delete/:email')\n  deleteUser(@Param('email') email:string) {\n    return this.userService.deleteUser(email)\n  }\n\n}\n\n```\n## 10.2.3 ì„œë¹„ìŠ¤ ìƒì„± \n### (1) ì„œë¹„ìŠ¤ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì™€ ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì´ì–´ì£¼ëŠ” ì—­í• , \n\n```TS\n//src/user/user.service.ts\n\n//User dto import\nimport { UserDto } from './user.model'\n\n// mogodb ìš© repository import \nimport { UserFileRepository, UserMongoRepository, UserRepository} from './user.repository'\n\n// ì˜ì¡´ì„± ì£¼ì… ê¸°ëŠ¥ import\nimport { Injectable } from '@nestjs/common'\n\n/* RDB ì„¤ì • ,typeORM */\nimport { InjectRepository } from '@nestjs/typeorm'\nimport { Repository } from 'typeorm'\nimport { User } from './user.entity'\nimport { ConfigService } from '@nestjs/config'\n\n// provider ì„ ì–¸! ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì‚¬ìš©. \n@Injectable()\nexport class UserService {\n    constructor(\n\n        @InjectRepository(User) private userRepository: Repository<User>\n    ) {}\n    // user ìƒì„± \n    createUser(user) : Promise<User> {\n        return this.userRepository.save(user)\n    }\n    // user í•œëª… ì •ë³´ ì°¾ê¸° \n    async getUser(email: string) {\n        const result = await this.userRepository.findOne({\n            where: { email }\n        })\n        return result\n    }\n    // user update (_user ëŠ” ìˆ˜ì •ëœ user ê°ì²´ì„ )\n    async updateUser(email, _user) {\n        const user : User = await this.getUser(email)\n        console.log(_user)\n        user.username = _user.username\n        user.password = _user.password\n        console.log(user)\n        this.userRepository.save(user)\n    }\n    // user ì •ë³´ ì‚­ì œ \n    deleteUser(email : any) {\n        return this.userRepository.delete({ email })\n    }\n}\n```\n- ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ë¦¬í¬ì§€í† ë¦¬(Repository from typeORM) ì€ ì–´ë””ì—ì„œ ê°€ì ¸ì˜¤ëŠ”ê°€? user.module ì„ ë§Œë“¤ì–´ì„œ ê°€ì ¸ì™€ì•¼í•¨. \n\n### (2) user.module ì— typeOrmModule ì„ import í•´ì„œ ì‚¬ìš©\n\n```TS\nimport { Module } from \"@nestjs/common\";\nimport { UserController } from \"./user.controller\";\nimport { UserService } from \"./user.service\";\nimport { TypeOrmModule } from \"@nestjs/typeorm\";\nimport { User } from \"./user.entity\";\n\n@Module({\n    imports : [TypeOrmModule.forFeature([User])],\n    controllers : [UserController],\n    providers : [UserService]\n\n})\nexport class UserModule {}\n```\n- User ë¼ëŠ” entity ê°€ ëª¨ë“ˆì— ì„í¬íŠ¸ ë˜ì–´ì„œ TypeORM ëª¨ë“ˆì— ë“±ë¡ë˜ì—ˆë‹¤. \n- ì¶”ê°€ë¡œ entityê°€ app.module ì—ì„œë„ ë“±ë¡ì´ ë˜ì–´ì•¼ë§Œ typeorm ì—ì„œ í•´ë‹¹ ì—”í‹°í‹°ì˜ ë©”íƒ€ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ìˆìŒ. => app.moudle entities ì— [User] ì¶”ê°€ .\n\n```TS\n// import { UserSchema, User } from './user/user.schema';\nimport { User } from './user/user.entity'; //typeORM ìš© ì—”í„°í‹° \n\n//... (ìƒëµ)\n\n    TypeOrmModule.forRoot({\n      type: 'sqlite',\n      database: 'user-auth.sqlite', //ë°ì´í„° ë² ì´ìŠ¤ íŒŒì¼ëª… \n      entities : [User], // ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ \n      synchronize: true, // ë°ì´í„° ë² ì´ìŠ¤ì— ìŠ¤í‚¤ë§ˆë¥¼ ë™ê¸°í™” \n      logging : true // sql ì‹¤í–‰ ë¡œê·¸ í™•ì¸ \n    }),\n```\n\n** UserModule ì„ ì„í¬íŠ¸ í•´ì£¼ê³  provider ì—ì„œ UserService ë¶€ë¶„ì„ ì£¼ì„ì²˜ë¦¬í•œë‹¤. ì´ê²Œ ì•ˆë˜ë©´ ê³„ì† mongoose ì™€ sqlite ê°€ ì¶©ëŒ \n```TS\n   // UserModule ì„ ì£¼ì…\n    UserModule\n\n  ],\n  controllers: [\n    TaskController,\n    ProjectController,\n    UserController,\n    ConfController],\n  providers: [\n    ProjectService, ProjectFileRepository, ProjectMongoRepository,\n    TaskService, TaskFileRepository, TaskMongoRepository,\n    //UserService,//UserFileRepository, UserMongoRepository\n  ],\n})\n```\n# test \n\n```Bash\n### USER create test\n curl -X POST \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"username\" :\"Forre\",\n     \"password\": \"grkcon2025!\",\n     \"email\":\"forre@grkcon.com\",\n     \"role\":\"admin\"\n     }' \\\n     http://localhost:3000/user/create\n### USER (Get User) test\ncurl -X GET http://localhost:3000/user/getUser/forre@grkcon.com\n\n### Update User \ncurl -X PUT \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"username\" :\"Forre\",\n     \"password\": \"grkcon2025!\",\n     \"role\":\"user\"\n     }' \\\n     http://localhost:3000/user/update/forre@grkcon.com\n\n### Delete User\ncurl -X DELETE http://localhost:3000/user/delete/forre@grkcon.com\n```\n- update í•  ë•Œ user.role <-> _user.role ì´ ì•ˆë˜ì–´ìˆì–´ì„œ ì—…ë°ì´íŠ¸ ë˜ì§€ ì•Šì•„ì„œ ìˆ˜ì •í•¨\n\n# 10.3 íŒŒì´í”„ë¡œ ìœ íš¨ì„± ê²€ì¦ \nì‚¬ìš©ìì—ê²Œ ë°›ì€ ì…ë ¥ê°’ì´ ìœ íš¨í•œì§€ ê²€ì¦ì€ í•„ìˆ˜ \nì‚¬ìš©ìì˜ ì…ë ¥ì€ ëŠ˜ ì˜ˆìƒì„ ë²—ì–´ë‚¨. \nNestJS ì—ì„œëŠ” íŒŒì´í”„ë¥¼ ì‚¬ìš©í•´ ìœ íš¨ì„± ê²€ì¦ì„í•¨. \në‹¤ì–‘í•œ íŒŒì´í”„ë“¤ì´ ìˆìœ¼ë©° ì§ì ‘ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ. \nê°€ì¥ ê°„ë‹¨í•œ ValidationPipe => class-validator, class-transformer ì„¤ì¹˜ í•„ìš” \n\ní´ë¼ì´ì–¸íŠ¸ì™€ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ì„ë•ŒëŠ” DTO ë¥¼ ì‚¬ìš©í•´ì•¼í•˜ë¯€ë¡œ UserDto ê°ì²´ë¥¼ ë§Œë“¤ì–´ ìœ íš¨ì„± ê²€ì¦ì— í•„ìš”í•œ ì¡°ê±´ì„ ì¶”ê°€ \n\n- ìœ íš¨ì„± ê²€ì¦ìœ¼ë¡œ @UsePipesë°ì½”ì™€ Joi ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ ìŠ¤í‚¤ë§ˆë¥¼ ë§Œë“¤ì–´ì•¼í•˜ê³  ë©”ì„œë“œë§ˆë‹¤ UsePipesë¥¼ ì¼ì¼íˆ ë¶™ì—¬ì•¼í•¨. \n\n\n## 10.3.1 ì „ì—­ ValidationPipe ì„¤ì •í•˜ê¸° \n\n```bash\nnpm install class-validator class-transformer\n```\n### (1) maiin.ts ì— ValidationPipe ì„¤ì • ì¶”ê°€ \n\n```TS\n//main.ts\n// íšŒì› ë¡œê·¸ì¸ì‹œ ìœ íš¨ì„± ê²€ì¦ì„ ìœ„í•œ ValidationPipe ì„í¬íŠ¸ \nimport { ValidationPipe } from '@nestjs/common'\n  // ì „ì—­ íŒŒì´í”„ì— validationPipe ì¶”ê°€ \n  app.useGlobalPipes(new ValidationPipe())\n```\n\n## 10.3.2. UserDto ìƒì„± \n\n### (1) user.dto.ts ì‘ì„± \n```TS\n//user.dto.ts\nimport { IsEmail, IsString } from \"class-validator\";\nexport class CreateDto {\n    @IsEmail()\n    email : string \n    @IsString()\n    password: string\n    @IsString()\n    username : string \n    @IsString() \n    role: string \n}\nexport class UpdateUserDto {\n    @IsString()\n    username: string\n    @IsString()\n    password: string \n}\n```\n### (2) Controller ì—ì„œ User íƒ€ì…ì„ dto ë¡œ ë³€ê²½ \n\n```TS\n\n// User DTO import \nimport { CreateUserDto, UpdateUserDto } from './user.dto'\n\n@Post('/create') \n  createUser(@Body() user: CreateUserDto) { ...\n\n@Put('/update/:email')\n  updateUser(@Param('email') email:string, @Body() user: UpdateUserDto) { ...\n```\n\n## 10.3.3 test \n\n```bash\n### USER create test wrong input error \ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"username\" :\"Forrea1\",\n    \"password\": \"grkcon2025!\",\n    \"email\":\"forres1temail.com\",\n    \"role\":\"admin\"\n    }' \\\n    http://localhost:3000/user/create\n```\n> {\"message\":[\"email must be an email\"],\"error\":\"Bad Request\",\"statusCode\":400}\n\n\n\nì°¸ê³  1. [ì´ë©”ì¼ ì¸ì¦ ì°¸ê³  1](https://velog.io/@kwontae1313/NestJS-%EC%9D%B4%EB%A9%94%EC%9D%BC-%EB%B3%B4%EB%82%B4%EA%B8%B0)\n\n[ì´ë©”ì¼ ì¸ì¦ ì°¸ê³ 2](https://suyeonme.tistory.com/108)\n\n[ì´ë©”ì¼ ì¸ì¦ ì°¸ê³  3](https://yoonchan1121.tistory.com/140)\n"
            ],
            "outputs": []
        },
        {
            "language": "markdown",
            "source": [
                "# [NestJS] ì‚¬ìš©ì ì¸ì¦ ëª¨ë“ˆ ìƒì„± ë° íšŒì› ê°€ì…í•˜ê¸°  [2ë‹¨ê³„]\n>ğŸŒ 2025.1.23 \n\n- ì¸ì¦ : ì‚¬ìš©ìì˜ ìê²©ì„ í™•ì¸\n- ì‚¬ìš©ìì˜ ìê²©ì¦ëª…ì„ ê¸°ì¡´ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í™•ì¸ í›„ ì¸ì¦ í† í°ì„ ë°œê¸‰í•¨. \n- ì‚¬ìš©ìì—ê²Œ ë¶€ì—¬ëœ ì¸ì¦ í† í°ì€ íŠ¹ì • ê¸°ê°„ ë™ì•ˆë§Œ ìœ íš¨ \n- ì¿ í‚¤ê¸°ë°˜, í† í°ê¸°ë°˜(ì¿ í‚¤ë¦¬ìŠ¤) ì¸ì¦ë²•ì´ ìˆìŒ. \n- ì„œë²„ì—ì„œ ë³´ë‚´ì¤€ ì¿ í‚¤ë¥¼ í´ë¼ì´ì–¸íŠ¸(ì£¼ë¡œë¸Œë¼ìš°ì €) ì— ì €ì¥í•´ ê´€ë¦¬í•¨. \n- í† í°ì€ ì„œë²„ì— ìƒíƒœë¥¼ ì €ì¥í•  í•„ìš”ê°€ ì—†ìŒ. \n- ì¿ í‚¤ì™€ í† í°ì€ ì„œë¡œ ì¥ë‹¨ì ì´ ìˆìŒ. \n- í† í°ì€ OAuth ë¥¼ ì‚¬ìš©í•œ ì†Œì…œ ë¡œê¸´ì—ì„œ ì‚¬ìš©í•  ì˜ˆì •, ë¨¼ì € ì¿ í‚¤ ì¸ì¦ì„ êµ¬í˜„ \n\n## 10.4.1 ì¸ì¦ ëª¨ë“ˆ ë§Œë“¤ê¸° ë° ì„¤ì • \n### (1) ì¸ì¦ ëª¨ë“ˆ ìƒì„±\n> ğŸ“Œ auth module > service > controller ìˆœ ìƒì„± \n```bash\nnest g module auth --no-spec\nnest g service auth --no-spec\nnest g controller auth --no-spec\n```\n\n> ì¸ì¦ ì‹œìŠ¤í…œ ë…¼ë¦¬ êµ¬ì¡° \n<img src=\"https://blog.kakaocdn.net/dn/Q7zyv/btsLWLQR4ot/VCdZxsFHKyzJRO8T5GECvK/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/Q7zyv/btsLWLQR4ot/VCdZxsFHKyzJRO8T5GECvK/img.webp\" data-origin-width=\"1192\" data-origin-height=\"520\" data-is-animation=\"false\" width=\"750\" height=\"327\" data-mce-selected=\"1\">\n\n### (2) UserService ë¥¼ AuthService ì—ì„œ ì£¼ì… í•˜ë„ë¡ user.module.ts ì— exports ì„¤ì •ì„ ì¶”ê°€í•¨. \n> ğŸ“Œ user/user.module.ts\n```ts\n// user/user.module.ts\nimport { Module } from \"@nestjs/common\";\nimport { UserController } from \"./user.controller\";\nimport { UserService } from \"./user.service\";\nimport { TypeOrmModule } from \"@nestjs/typeorm\";\nimport { User } from \"./user.entity\";\n@Module({\n    imports : [TypeOrmModule.forFeature([User])],\n    controllers : [UserController],\n    providers : [UserService],\n    //UserService ë¥¼ ì™¸ë¶€ë¡œ ë…¸ì¶œí•´ì•¼í•¨. \n    exports: [UserService]\n})\nexport class UserModule {}\n\n```\n\n\n## 10.4.2. íšŒì› ê°€ì… ë©”ì„œë“œ ìƒì„± \n### (1) UserService í´ë˜ìŠ¤ì˜ creatUser ì‚¬ìš© , ë¹„ë°€ë²ˆí˜¸ ê°™ì€ ì •ë³´ ì•”í˜¸í™”\n> bcrypt  ì„¤ì¹˜ \n```bash\nnpm install bcrypt\nnpm install -D @types/bcrypt \n```\n\n\n### (2) ì„œë¹„ìŠ¤ -> ì»¨íŠ¸ë¡¤ëŸ¬  ì½”ë“œ ì‘ì„± \n> src/auth/auth.service.ts \n```TS\n//src/auth/auth.service.ts \n// ** HTTP , DTO, service import\nimport { HttpException, HttpStatus, Injectable } from '@nestjs/common';\nimport { CreateUserDto } from 'src/user/user.dto';\nimport { UserService } from 'src/user/user.service';\n// ** íšŒì› ì •ë³´ ì•”í˜¸í™” ë¼ì´ë¸ŒëŸ¬ë¦¬ \nimport * as bcrypt from 'bcrypt'\n// \n// import { User } from 'src/user/user.schema';\nimport { User } from 'src/user/user.entity';\n\n@Injectable() // provider \nexport class AuthService {\n    constructor(private userService: UserService) {}\n\n    async register(userDto : CreateUserDto) {\n        // 1. ì´ë¯¸ ê°€ì…ëœ ìœ ì € ìˆëŠ”ì§€ ì²´í¬ \n        const user = await this.userService.getUser(userDto.email)\n        if (user) {\n            // ì´ë¯¸ ê°€ì…ëœ ìœ ì € ìˆì„ ê²½ìš° ì—ëŸ¬ ë°œìƒ \n            throw new HttpException(\n                'í•´ë‹¹ ìœ ì €ê°€ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤. ',\n                HttpStatus.BAD_REQUEST\n            )\n        }\n        // password ì•”í˜¸í™” \n        const encryptedPassword = await bcrypt.hash(userDto.password, 10)\n        // db ì €ì¥, ì €ì¥ì¤‘ error ë‚˜ë©´ ì„œë²„ ì—ëŸ¬ ë°œìƒ \n        try {\n            const user = await this.userService.createUser({\n                ...userDto,\n                password: encryptedPassword\n            })\n            // íšŒì› ê°€ì… í›„ ë°˜í™˜í•˜ëŠ” ê°’ì—ëŠ” password ë¥¼ ì£¼ì§€ ì•ŠìŒ. \n            user.password =undefined\n            return user\n        } catch (error) {\n            throw new HttpException('ì„œë²„ ì—ëŸ¬ ', 500)\n        }\n    }\n}\n```\n\n### (3) ì»¨íŠ¸ë¡¤ëŸ¬ ìƒì„±(rough)\n>//auth.controller.ts\n```TS\nimport { Controller, Body, Get, Post } from '@nestjs/common';\nimport { CreateUserDto } from 'src/user/user.dto';\nimport { AuthService } from './auth.service';\nimport chalk from 'chalk';\n\n@Controller('auth')\nexport class AuthController {\n    constructor(private authService : AuthService) {}\n\n    // ë“±ë¡ ìš”ì²­ì„ ë°›ìœ¼ë©´ CreateUserDto ê°ì²´ \n    @Post('register')\n    async register(@Body() userDto: CreateUserDto) {\n        console.log(chalk.yellow(\" >> register start\"))\n        return await this.authService.register(userDto)\n    }\n}\n```\n- **ğŸ¤” @Body() userDto: CreateUserDto** í•´ì„\n  - @Body ë°ì½”ë ˆì´í„°ëŠ” ìš”ì²­ ë³¸ë¬¸ì—ì„œ ë°ì´í„°ë¥¼ ì¶”ì¶œ í•¨. \n  - ë°ì½”ë ˆì´í„°ë¡œ ì¶”ì¶œí•œ ê²ƒì„ CreateUserDto íƒ€ì…ì˜ ê°ì²´ë¡œ ë³€í™˜ë˜ì–´ userDto ë³€ìˆ˜ì— í• ë‹¹í•¨. \n\n\n## 10.4.3 SQLite ìµìŠ¤í…ì…˜ìœ¼ë¡œ í…Œì´ë¸” í™•ì¸ \n\n> sqlite extension install > user-auth.sqlite  check\n<img src=\"https://blog.kakaocdn.net/dn/bRK3iR/btsLZvS2Kzf/WGLvJafbNqodY2xGDOFZSk/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/bRK3iR/btsLZvS2Kzf/WGLvJafbNqodY2xGDOFZSk/img.webp\" data-origin-width=\"2348\" data-origin-height=\"604\" data-is-animation=\"false\" width=\"755\" height=\"194\">\n\n\n\n# 10.5 ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ ì¸ì¦ êµ¬í˜„ \n\n1. AuthController ì— login í•¸ë“¤ëŸ¬ ë©”ì„œë“œ êµ¬í˜„\n>ğŸ¤”í•¸ë“¤ëŸ¬ë€? : í•¸ë“¤ëŸ¬ëŠ” íŠ¹ì • ìš”ì²­(Get,Put,Post,Delete)ì„ ì²˜ë¦¬í•˜ëŠ” ì—­í• ì„ í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.\n\n2. Controller > AuthService ë¡œ email, password íŒŒë¼ë¯¸í„°ë¥¼ Dto í˜•íƒœë¡œ ë„˜ê²¨ ì£¼ë©´ DB ì— í•´ë‹¹ ì •ë³´ ìœ ì €ê°€ ìˆëŠ”ì§€ ìœ íš¨ì„± ê²€ì¦ì„ í•˜ëŠ” ë¡œì§ êµ¬í˜„.\n \n3. ìœ ì € ì •ë³´ì˜ ìœ íš¨ì„± ê²€ì¦ì´ ëë‚˜ë©´ ì‘ë‹µ ê°’ì— ì¿ í‚¤ ì •ë³´ë¥¼ ì¶”ê°€í•´ ë°˜í™˜í•¨. \n4. NestJS ì—ì„œ ì¸ì¦ì„ êµ¬í˜„í• ë•Œ ë³´í†µ ì¸ì¦ìš© ë¯¸ë“¤ì›¨ì–´ì¸ ê°€ë“œë¥¼ í•¨ê»˜ ì‚¬ìš©í•¨. \n> âœ… ê°€ë“œëŠ” íŠ¹ì • ìƒí™©(ê¶Œí•œ,ë¡¤,ì•¡ì„¸ìŠ¤ì»¨íŠ¸ë¡¤) ì—ì„œ ë°›ì€ ìš”ì²­request ë¥¼ ê°€ë“œë¥¼ ì¶”ê°€í•œ ë¼ìš°íŠ¸ ë©”ì„œë“œì—ì„œ ì²˜ë¦¬í• ì§€ ë§ì§€ë¥¼ ê²°ì •í•˜ëŠ” ì—­í• ì„ í•¨. \n\n## 10.5.1 AuthService ì— ì´ë©”ì¼ê³¼ íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ë¡œì§ ë§Œë“¤ê¸° \n### (1) ìœ ì €ì˜ ì´ë©”ì¼ê³¼ íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ë¡œì§ \n> ğŸ“Œ auth/auth.service.ts\n```TS\n    // íšŒì› ê²€ì¦ \n    async validateUser(email: string, password: string) {\n        const user = await this.userService.getUser(email)\n        // ì´ë©”ì¼ë¡œ ìœ ì € ì •ë³´ë¥¼ ë°›ìŒ. \n        if (!user) { // ìœ ì €ê°€ ì—†ëŠ” ê²½ìš° -> ê²€ì¦ ì‹¤íŒ¨ \n            return null\n        }\n        const { password: hashedPassword, ...userInfo } =user\n\n        if (bcrypt.compareSync(password, hashedPassword)) {\n            // password ì¼ì¹˜ \n            return userInfo\n        }\n        return null\n    }\n```\n\n### (2) validateUser() ë©”ì„œë“œë¥¼ AuthController ì—ì„œ ì‚¬ìš©í•´ ì¸ì¦ ê²°ê³¼ë¥¼ ì¿ í‚¤ì— ì¶”ê°€ \n> ğŸ“Œ auth/auth.controller.ts\n```TS\n    @Post('login')\n    async login(@Request() req, @Response() res) {\n        // validateUser\n        const userInfo = await this.authService.validateUser(\n            req.body.email,\n            req.body.password\n        )\n        // ìœ ì € ì •ë³´ê°€ ìˆìœ¼ë©´, ì¿ í‚¤ ì •ë³´ë¥¼ response ì €ì¥ \n        if (userInfo) {\n            res.cookie('login', JSON.stringify(userInfo), {\n                httpOnly: false, \n                maxAge: 1000 * 60 * 60 * 24 * 1 //7 day ë‹¨ìœ„ëŠ” ë°€ë¦¬ì´ˆ ì¿ í‚¤ ì§€ì† ì‹œê°„ \n            })\n        }\n        return res.send({ message: 'login success'})\n    } \n```\n- login()ì€ Request ì™€ Responseë¥¼ ëª¨ë‘ ì‚¬ìš©í•´ì•¼ í•˜ë¯€ë¡œ @Bodyë‚˜ @Param ì´ ì•„ë‹Œ @Request ë¥¼ ì§ì ‘ ì‚¬ìš©í•¨. Response ê°ì²´ëŠ” ì¿ í‚¤ë¥¼ ì„¤ì •í• ë•Œ ì‚¬ìš©í•¨. \n- ì•ì„œ ë§Œë“  authService ì˜ validateUserë¥¼ í˜¸ì¶œí•´ íŒ¨ìŠ¤ì›Œë“œë¥¼ ì œì™¸í•œ ìœ ì € ì •ë³´ë¥¼ ë°›ìŒ.  ìœ ì € ì •ë³´ê°€ ìˆìœ¼ë©´  res.cookie ë¥¼ ì‚¬ìš©í•´ ì¿ í‚¤ë¥¼ ì„¤ì •í•¨. \n- httpOnly ë¥¼ true ë¡œ ì„¤ì •í•˜ì—¬ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ë¥¼ ì½ì§€ ëª»í•˜ê²Œ í•¨. \n- ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ë¥¼ ì½ì„ìˆ˜ ìˆìœ¼ë©´ XSS(Cross Site Scripting) ë“±ì˜ ê³µê²©ìœ¼ë¡œ ì¿ í‚¤ íƒˆì·¨ ê°€ ê°€ëŠ¥í•¨. ëª…ì‹œì ìœ¼ë¡œ false ë¥¼ ì¤Œ. ì›ë˜ ê¸°ë³¸ê°’ë„ false ì„.\n-ì¿ í‚¤ ì •ë³´ë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì½ì§€ ì•Šì•„ë„ ëœë‹¤ë©´ true ì„¤ì •ì´ ë³´ì•ˆì— ë” ìœ ë¦¬ \n\n### (3) login test \n\n```bash\n### USER login test\n curl -X POST \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n     \"email\":\"forre@grkcon.com\",\n     \"password\":\"grkcon2025!\"\n     }' \\\n     http://localhost:3000/auth/login\n```\n- curl ì—ì„œëŠ” ì¿ í‚¤ê°€ ëœ¨ì§€ì•Šê³ . test.http íŒŒì¼ì—ì„œ ì ‘ê·¼í•˜ë©´  ì—°ê²°ìì²´ê°€ ì•ˆë¨. \n- curl ëª…ë ¹ì—ì„œ -v ì„¤ì •ì„ ì¶”ê°€í•˜ë©´ ì¿ í‚¤ê°€ ë³´ì„, -c cookie.txt íŒŒì¼ì— ì¿ í‚¤ ì €ì¥ í•˜ê³  -b cookie.txt íŒŒì¼ì—ì„œ ì¿ í‚¤ì½ì–´ì™€ì„œ ì ‘ê·¼í•˜ë©´ ì˜¤ë¥˜ê°€ ì‚¬ë¼ì§\n- type script ë¡œ ì¿ í‚¤ í™•ì¸í• ìˆ˜ìˆëŠ” ì½”ë“œ \n> ğŸ“Œ auth.test.ts\n```ts\nconst data = {\n    email: \"test1@grkcon.com\",\n    password: \"grkcon2025!\"\n  };\n  \n  fetch(\"http://localhost:3000/auth/login\", {\n      method: \"POST\",\n      headers: {\n          \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(data),\n  })\n  .then((response) => {\n       const setCookieHeaders = [];\n       const cookies = [];\n       \n       response.headers.forEach((value, key) => {\n           if (key.toLowerCase() === \"set-cookie\") {\n              setCookieHeaders.push(value);\n               const parsedCookies = value.split(';').reduce((acc, cookie) => {\n                  const [name, value] = cookie.trim().split('=');\n                  if (name && value) {\n                      acc[name] = value;\n                  }\n                  return acc;\n              }, {});\n              cookies.push(parsedCookies)\n           }\n       });\n    \n       console.log(\"Set-Cookie í—¤ë”ë“¤:\", setCookieHeaders);\n       console.log(\"íŒŒì‹± ëœ ì¿ í‚¤ë“¤:\", cookies)\n    return response.json();\n  })\n  .then((result) => console.log(\"ì‘ë‹µ ê²°ê³¼:\", result))\n  .catch((error) => console.error(\"ì˜¤ë¥˜ ë°œìƒ:\", error));\n```\n\n## 10.5.2 ê°€ë“œë¥¼ ì‚¬ìš©í•´ ì¸ì¦ë¬ëŠ”ì§€ ê²€ì‚¬\n- Nest.js ì¸ì¦ì‹œ ê°€ë“œë¼ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ë³´í¸ì ìœ¼ë¡œ ì‚¬ìš©í•¨. \n- ê°€ë“œëŠ” @Injectable() ë°ì½”ê°€ ë¶™ì–´ìˆê³  CanActive ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•œ í´ë˜ìŠ¤ì„. \n- @UseGuard ë¡œ ì‚¬ìš©í• ìˆ˜ë„ ìˆìŒ. \n- í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ @Get, @Post ë“±ì´ ë¶™ì–´ìˆëŠ” í•¸ë“¤ëŸ¬ ë©”ì„œë“œì— ë„˜ê¸°ê¸° ì „ì— ì¸ì¦ì— ê´€ë ¨ëœ ì²˜ë¦¬ë¥¼ í• ìˆ˜ ìˆìŒ. \n- CanActivate ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ canActivate() ë©”ì„œë“œë¥¼ êµ¬í˜„í•´ì•¼í•¨. \n- CanActiavet ëŠ” boolean or Promise<boolean>ì„ ë°˜í™˜ true ì¸ê²½ìš° í•¸ë“¤ëŸ¬ ë©”ì„œë“œ ì‹¤í–‰, false ì´ë©´ 403 forbidden ì—ëŸ¬ë¥¼ ë°˜í™˜ \n> NestJS ê°€ë“œ ì¸ì¦ ë…¼ë¦¬êµ¬ì¡° \n<img src=\"https://blog.kakaocdn.net/dn/IqzdO/btsL0PyJxSx/3IFaRQsUi2JC1SLfYw61QK/img.jpg\" data-mce-src=\"https://blog.kakaocdn.net/dn/IqzdO/btsL0PyJxSx/3IFaRQsUi2JC1SLfYw61QK/img.jpg\" data-origin-width=\"906\" data-origin-height=\"730\" data-is-animation=\"false\" width=\"756\" height=\"609\">\n\n### (1) ì„œë²„ì¸¡ì—ì„œ http í—¤ë”ì— ìˆëŠ” ì¿ í‚¤ë¥¼ ì½ëŠ” ì½”ë“œ ì‘ì„±. \n- cookie-parser íŒ¨í‚¤ì§€ ì„¤ì¹˜ \n```bash\nnpm install cookie-parser\n```\n\në©”ì¸ ì— ì½”ë“œ ì¶”ê°€ \n> ğŸ“Œ src/main.ts\n```TS\n// cookie \nimport * as cookieParser from 'cookie-parser'\n///( ìƒëµ ..)\nasync function bootstrap() {\n  // Cookie parser ì‚¬ìš© \n  app.use(cookieParser())\n}\n```\n- ì¿ í‚¤ íŒŒì„œëŠ” request ê°ì²´ì—ì„œ ì½ì–´ì˜¤ëŠ”ë° ì‚¬ìš©í•˜ëŠ” ë¯¸ë“¤ì›¨ì–´ì„ \n- NestFactory.createë¡œ ë§Œë“  NestApplication ì˜ ê°ì²´ì¸ appì—ì„œ use() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•œì¤„ë§Œ ì¶”ê°€í•˜ë©´ ë¨.\n\n\n### (3) auth.guard.ts ì‘ì„± \n- authService ì˜ validateUser ì‚¬ìš©í•˜ì—¬ ê°€ë“œ ìƒì„± \n- src/auth ì•„ë˜ì— auth.guard.ts íŒŒì¼ ìƒì„± \n\n\n```TS\n/// src/auth/auth.guard.ts\n\nimport { CanActivate, ExecutionContext, Injectable} from '@nestjs/common'\n\nimport { AuthService } from './auth.service'\nimport { Observable } from 'rxjs'\n\n@Injectable()\nexport class LoginGuard implements CanActivate {\n\n    constructor(private authService: AuthService) {}\n    // CanActivate ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œ \n    async canActivate(context: any): Promise<boolean> {\n        // ì»¨í…ìŠ¤íŠ¸ì—ì„œ ë¦¬í€˜ìŠ¤íŠ¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜´\n        const request =  context.switchToHttp().getRequest()\n        // ì¿ í‚¤ê°€ ìˆìœ¼ë©´ ì¸ì¦ëœ ê²ƒ\n        if (request.cookies['login']) {\n            return true\n        }\n        // ì¿ í‚¤ê°€ ì—†ìœ¼ë©´ request ì˜ bodyì •ë³´ í™•ì¸ \n        if (!request.body.email || !request.body.password) {\n            return false \n        }\n\n        //ê¸°ì¡´ì˜ authService.validateUser ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ì¦\n        const user = await this.authService.validateUser(\n            request.body.email,\n            request.body.password\n        )\n        // ìœ ì € ì •ë³´ ì—†ì„ì‹œ false\n        if (!user) {\n            return false \n        }\n        // ìœ ì €ì •ë³´ê°€ ìˆìœ¼ë©´ request ì— user ì •ë³´ ì¶”ê°€í›„ true \n        request.user = user\n        return true \n    }\n}\n```\n- @Injectable ì´ ìˆìœ¼ë¯€ë¡œ ë‹¤ë¥¸ í´ë˜ìŠ¤ ì£¼ì…ê°€ëŠ¥ , CanActive ìˆìœ¼ë¯€ë¡œ ê°€ë“œ í´ë˜ìŠ¤ì„. \n- ì¸ì¦ì‹œ authService ê°ì²´ ì£¼ì…, canActivate() ëŠ” ì¶”ìƒ ë©”ì„œë“œì´ë¯€ë¡œ ì‚¬ìš©í•  í´ë˜ìŠ¤ì—ì„œ êµ¬í˜„í•´ì•¼í•¨. ë°˜í™˜ íƒ€ì… ì€ async ì´ë¯€ë¡œ Promise boolean íƒ€ì…ìœ¼ë¡œ ì‚¬ìš© \n- true: ì¸ì¦ë¨, false: ì¸ì¦ ì•ˆë¨. \n\n\n### (4) auth.controller ì— useGuard ë¥¼ í™œìš©í•œ login2 í•¨ìˆ˜ ì‘ì„± \n> auth.controller.ts \n```TS\n   // ì‚¬ìš©ì ì¸ì¦ \n    @UseGuards(LoginGuard)\n    @Post('login2')\n    async login2(@Request() req, @Response() res) {\n        // ì¿ í‚¤ì •ë³´ëŠ” ì—†ì§€ë§Œ requestì— user ì •ë³´ê°€ ìˆë‹¤ë©´ ì‘ë‹µê°’ì— ì¿ í‚¤ ì •ë³´ ì¶”ê°€ \n        if (!req.cookies['login'] && req.user) {\n            // ì‘ë‹µì— ì¿ í‚¤ ì •ë³´ ì¶”ê°€ \n            res.cookie('login', JSON.stringify(req.user), {\n                httpOnly: true,\n                maxAge: 1000 * 10 // test ìš© \n            })\n        }\n        return res.send({message: 'login2 success'})\n\n    }\n    // ë¡œê·¸ì¸ì„ í•œ ë•Œë§Œ ì‹¤í–‰ë˜ëŠ” ë©”ì„œë“œ \n    @UseGuards(LoginGuard)\n    @Get('test-guard')\n    testGuard() {\n        return 'ë¡œê·¸ì¸ ëœ ë–„ë§Œ ì´ ê¸€ì´ ë³´ì…ë‹ˆë‹¤. '\n    }\n}\n```\n\n### (5) ì¿ í‚¤ ë¡œê·¸ì¸ ì¸ì¦ test \n> âœ… ê¸°ì¡´ì— create ë¡œ ìƒì„±ëœ ì•„ì´ë””ë“¤ì€ í…ŒìŠ¤íŠ¸ë¥¼ í• ìˆ˜ì—†ìŒ auth/register ë¡œ ìƒì„±ëœ ì•„ì´ë””ë“¤ë§Œ auth guard ì— ì¸ì‹ì´ ë˜ë©° ì¿ í‚¤ê°€ ìƒì„±ë¨ \n\n> ë¡œê·¸ì¸ > login2(byì¿ í‚¤) Curl test\n```bash\n### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ê¸°ë¡ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon2025!\"\n    }' \\\n    -c cookies.txt \\\n    http://localhost:3000/auth/login\n\n### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ì½ì–´ì„œ login2 ì¿ í‚¤ í™•ì¸ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon2025!\"\n    }' \\\n    -b cookies.txt \\\n    http://localhost:3000/auth/login2\n    \n### USER login  ì¿ í‚¤ ì¸ì¦ test\ncurl -X GET -b cookies.txt http://localhost:3000/auth/test-guard\n```\n# TEST RESULT\n<img src=\"https://blog.kakaocdn.net/dn/KYy7a/btsL3guLj2g/tcr5lb1Y9eAQ6sm2KdrZY0/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/KYy7a/btsL3guLj2g/tcr5lb1Y9eAQ6sm2KdrZY0/img.webp\" data-origin-width=\"1978\" data-origin-height=\"996\" data-is-animation=\"false\" width=\"757\" height=\"381\" data-mce-selected=\"1\">\n"
            ],
            "outputs": []
        },
        {
            "language": "markdown",
            "source": [
                "\n# 10.6 íŒ¨ìŠ¤í¬íŠ¸ì™€ ì„¸ì…˜ì„ ì‚¬ìš©í•œ ì¸ì¦ êµ¬í˜„ \n> 2025.1.27\n\n- ì„œë²„ì—ì„œ ì¸ì¦ì„ í•˜ê³  í•´ë‹¹ ì •ë³´ë¥¼ ì„œë²„ì˜ íŠ¹ì •ê³µê°„ì— ì €ì¥.(ì„¸ì…˜ ì´ìš©)\n- ì¿ í‚¤ëŠ” ì„¸ì…˜ì„ ì°¾ëŠ” ì •ë³´ë§Œ ì €ì¥(ì„¸ì…˜ì˜ ì•„ì´ë””ê°’) ì¤‘ìš” ì •ë³´ëŠ” ì„¸ì…˜ì— ëª¨ë‘ ë„£ìŒ. \n- ì„¸ì…˜ì€ ì„œë²„ì˜ ìì›ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì— ë¶€í•˜ë¥¼ ì£¼ì§€ë§Œ ìœ„ì¡°,ë³€ì¡°,íƒˆì·¨ê°€ ë¶ˆê°€ëŠ¥í•˜ì—¬ ë³´ì•ˆì ì„. \n- ê°€ë“œí•˜ë‚˜ë¡œ ë¡œê·¸ì¸ê³¼ ì¸ì¦ ëª¨ë‘ ì‚¬ìš©í–ˆì§€ë§Œ ê°€ë“œ ë‘ê°œì™€ ì¸ì¦ ì²˜ë¦¬ë¥¼ í•˜ê¸°ìœ„í•œ íŒŒì¼ì„ ì—¬ëŸ¬ê°œ ë§Œë“¤ê²ƒ. \n- ë¡œê·¸ì¸ì— ì‚¬ìš©í•  ê°€ë“œ. \n- ì¸ì¦ ë¡œì§ êµ¬í˜„ ë¶€ë¶„ì€ íŒ¨ìŠ¤í¬íŠ¸ ë¼ëŠ” ì¸ì¦ ë¡œì§ì„ ì‰½ê²Œ ë¶„ë¦¬í•´ì„œ ê°œë°œí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© \n- íŒ¨ìŠ¤í¬íŠ¸ ì‚¬ìš©ì‹œ ì¸ì¦ ë¡œì§ì€ ìŠ¤íŠ¸ë˜í‹°ì§€ íŒŒì¼ì„ ìƒì„±í•´ì„œ ì‚¬ìš©. \n- íŒ¨ìŠ¤í¬íŠ¸ëŠ” ì¸ì¦ ë¡œì§ ìˆ˜í–‰ì„ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ë¥¼ ì˜ë¯¸í•¨. \n- ë‹¤ì–‘í•œ ì¸ì¦ì„ ìœ„í•œ ìŠ¤íŠ¸ë˜í‹°ì§€ íŒ¨í‚¤ì§€ë¥¼ ê°™ì´ ì„¤ì¹˜í•´ ì¸ì¦ì„ ì‰½ê²Œ êµ¬í˜„ê°€ëŠ¥. \n- ê°€ë“œ ì•ˆì— ì¸ì¦ ë¡œì§ì„ ë‘ëŠ”ê²ƒì´ ì•„ë‹Œ ì¸ì¦ë¡œì§ì„ ì²˜ë¦¬í•˜ëŠ” ë³„ë„ì˜ ìŠ¤íŠ¸ë˜í‹°ì§€ íŒŒì¼ ì‘ì„± \n- id, password ì£¼ì—ˆì„ë•Œ ì˜¬ë°”ë¥¸ ì •ë³´ì¸ì§€ íŒë‹¨í•˜ëŠ”ë¡œì§, ì¿ í‚¤ì—ì„œ ê°’ì„ ì½ì–´ ì¸ì¦ì„ ã…Ÿí•œ ì˜¬ë°”ë¥¸ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ê²€ì¦í•˜ëŠ” ë¡œì§ ì˜ë¯¸ \n- ì„¸ì…˜ì—ì„œ ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ê³  ì €ì¥í•˜ë¯€ë¡œ ì„¸ì…˜ì— ë°ì´í„° ì €ì¥í•˜ê³  ì½ì–´ì˜¬ ì„¸ì…˜ ì‹œë¦¬ì–¼ë¼ì´ì €(session serializer) íŒŒì¼ë„ í•„ìš”í•¨. \n- ê°€ë“œ íŒ¨ìŠ¤í¬íŠ¸ ìŠ¤íŠ¸ë˜í‹°ì§€, ì„¸ì…˜ ì‹œë¦¬ì–¼ë¼ì´ì €ê°€ ì„œë¡œ í˜‘ë ¥í•˜ì—¬ ì‚¬ìš©ì ì‹ ì›ì„ í™•ã…‡ë‹ˆí•˜ê³  ì´ì¦ ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ì½ì–´ì™€ì„œ ë‹¤ì‹œ ì¸ì¦í•˜ëŠ” ì‘ì—…ì„ í•¨. ì—­í•  ë¶„ë‹´ì´ ì˜ë˜ì–´ ìˆì–´ì„œ ìœ ì§€ë³´ìˆ˜ì— ìœ ë¦¬í•¨. \n- \n<img src=\"https://blog.kakaocdn.net/dn/tcKVh/btsL2PYoHQ1/8CxqnWmk2T89kFRcdFhhyk/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/tcKVh/btsL2PYoHQ1/8CxqnWmk2T89kFRcdFhhyk/img.webp\" data-origin-width=\"1194\" data-origin-height=\"524\" data-is-animation=\"false\" width=\"748\" height=\"328\">\n\n\n## 10.6.1 ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ë° ì„¤ì • \n### (1) passport ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ \n> passport-local : username ê³¼ password ë¡œ ì¸ì¦ì „ëµ ëª¨ë“ˆ \n> ì„¸ì…˜ ì €ì¥ì—ëŠ” express-session ì‚¬ìš© \n> ê°œë°œí• ë•Œ ìœ ìš©í•˜ë¯€ë¡œ ê°œë°œ í™˜ê²½ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•˜ëŠ” -D ì˜µì…˜ì„ ì£¼ì–´ ì„¤ì¹˜í•¨. \n```bash\nnpm i @nestjs/passport passport passport-local express-session\nnpm i -D @types/passport-local @types/express-session \n```\n\n### (2) ì„¸ì…˜ì„ ì‚¬ìš©í•˜ë ¤ë©´ main.ts íŒŒì¼ì— ì„¤ì • ì¶”ê°€ \n\n> ğŸ“Œ src/main.ts\n```ts\n// ë¡œê·¸ì¸ ì¸ì¦ì„ ìœ„í•œ ì„¸ì…˜, passport ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„í¬íŠ¸ \nimport * as session from 'express-session'\nimport * as passport from 'passport'\n\n//(ìƒëµ)\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  // session ì„¤ì • \n  app.use(\n    session({\n      secret: 'very-important-secret', // ì„¸ì…˜ ì•”í˜¸í™” í‚¤ \n      resave: false, // ì„¸ì…˜ì„ í•­ìƒ ì €ì¥í• ì§€ ì—¬ë¶€ \n      // ì„¸ì…˜ ì €ì¥ë˜ê¸° ì „ ì´ˆê¸°í™” ë˜ì§€ ì•Šì€ ìƒíƒœë¡œ ì„¸ì…˜ì„ ë¯¸ë¦¬ ì €ì¥ \n      saveUninitialized: false, \n      cookie: {maxAge: 3600000} // ì¿ í‚¤ ìœ íš¨ì‹œê°„ 1ì‹œê°„\n    })\n  )\n  // passport ì‹œì‘, session  ì„ ì–¸\n  app.use(passport.initialize())\n  app.use(passport.session())\n```\n\n## 10.6.2 ë¡œê·¸ì¸ê³¼ ì¸ì¦ì— ì‚¬ìš©í•  ê°€ë“œ êµ¬í˜„ \në¡œê·¸ì¸ì— ì‚¬ìš©í•  ê°€ë“œì™€ ë¡œê·¸ì¸í›„ ì¸ì¦ì— ì‚¬ìš©í•  ê°€ë“œë¥¼ ë³„ê°œë¡œ ìƒì„±í•˜ì—¬ ì‚¬ìš© \nloginAuthGuard ëŠ” HTTp ìš”ì²­ì„ ë°›ì€ email ê³¼ password ì •ë³´ë¡œ ìœ íš¨í•œ user ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ ìœ íš¨í•  ê²½ìš° ìœ ì € ì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥. \nAuthenticatedGuard ëŠ” HTTP ìš”ì²­ì— ì‡ëŠ” ì¿ í‚¤ë¥¼ ì°¾ì•„ ì¿ í‚¤ì— ìˆëŠ” ì •ë³´ë¡œ ì„¸ì…˜ì„ í•™ì¸í•´ ë¡œê·¸ì¸ì´ ì™„ë£Œëœ ì‚¬ìš©ìì¸ì§€ íŒë³„ \n- LoginAuthGuard ì™€ AuthenticatedGuard ê°€ë“œë¥¼ auth.guard.ts ì— ì¶”ê°€\n\n<img src=\"https://blog.kakaocdn.net/dn/bMUvMM/btsL19cgGma/NjDm7YBA6LgNpvIo2Tuty1/img.jpg\" data-mce-src=\"https://blog.kakaocdn.net/dn/bMUvMM/btsL19cgGma/NjDm7YBA6LgNpvIo2Tuty1/img.jpg\" data-origin-width=\"942\" data-origin-height=\"484\" data-is-animation=\"false\" width=\"757\" height=\"389\">\n\n```ts\n/// src/auth/auth.guard.ts\n\n// Guard ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì„í¬íŠ¸ \nimport { CanActivate, ExecutionContext, Injectable, Request} from '@nestjs/common'\n\n// íŒ¨ìŠ¤í¬íŠ¸ ì‚¬ìš©í•˜ëŠ” AuthGuard ì„í¬íŠ¸ \nimport { AuthGuard } from '@nestjs/passport';\nimport { AuthService } from './auth.service'\n\n@Injectable()\n// AuthGuard ìƒì† \nexport class LocalAuthGuard extends AuthGuard('local') {\n  async canActivate(context: any):   Promise<boolean>  {\n    const result = (await super.canActivate(context)) as boolean\n    // ë¡œì»¬ ìŠ¤íŠ¸ë˜í‹°ì§€ ì‹¤í–‰ \n    const request = context.switchToHttp().getRequest()\n    // ì„¸ì…˜ ì €ì¥ \n    await super.logIn(request)\n    return result \n      \n  }\n}\n\n@Injectable() \nexport class AuthenticatedGuard implements CanActivate {\n  canActivate(context: ExecutionContext):  boolean{\n        const request = context.switchToHttp().getRequest()\n        // ì„¸ì…˜ì—ì„œ ì •ë³´ë¥¼ ì½ì–´ì„œ ì¸ì¦ í™•ì¸ \n        return request.isAuthenticated()\n  }\n}\n```\n- íŒ¨ìŠ¤ í¬íŠ¸ ì¸ì¦ì— ê°€ë“œë¥¼ ì‚¬ìš©í• ìˆ˜ ìˆë„ë¡ ê°ì‹¸ë‘” AuthGuard ë¥¼ ì œê³µí•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ \n- íŒ¨ìŠ¤í¬íŠ¸ëŠ” ì¸ì¦ë¡œì§ì„ ìŠ¤íŠ¸ë˜í‹°ì§€ ê°œë…ìœ¼ë¡œ êµ¬í˜„. \n- ì´ì™¸ì— ìŠ¤íŠ¸ë ˆí‹°ì§€ë¡œ passport-jwt ì™€ passport-google-oauth20 ì´ ìˆìŒ. \n- ê°€ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ canActivateë¥¼ êµ¬í˜„ \n- AuthGuard ìƒì† í•˜ì—¬ super.canActivate() ì— ì„œ passport-local ë¡œì§ì„ êµ¬í˜„í•  ë©”ì„œë“œ ì‹¤í–‰í•¨. \n- local.startagy.ts íŒŒì¼ì´ localStrategy í´ë˜ìŠ¤ ìƒì„±í•œí›„ valdiate() ë©”ì„œë“œ êµ¬í˜„ \n- super.logIn()ì—ì„œ ë¡œê·¸ì¸ ì²˜ë¦¬, ì„¸ì…˜ì €ì¥í•¨. ì„¸ì…˜ì—ì„œ êº¼ë‚´ì˜¤ëŠ” ë°©ë²•ì€ session.serializaer.ts íŒŒì¼ì—ì„œ ì‘ì„± \n- AuthenticatedGuard ê°€ ë¡œê·¸ì¸ í›„ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸í• ë•Œ ì‚¬ìš©. \n- ì„¸ì…˜ì— ë·ì´í„°ë¥¼ ì €ì¥í•˜ê³  ëŒë ¤ì£¼ëŠ” ì‘ë‹µê°’ì— connect.sid ë¼ëŠ” ì´ë¦„ì˜ ì¿ í‚¤ë¥¼ ë§Œë“¬. \n- ì´í›„ ìš”ì²­ì— í•´ë‹¹ ì¿ í‚¤ê°’ì„ ê°™ì´ ì „ì†¡í•˜ë©´ ì„¸ì…˜ì— ìˆëŠ” ê°’ì„ ì½ì–´ ì¸ì¦ ì—¬ë¶€ë¥¼ í™•ì¸ í• ë–„ ì‚¬ìš©í•¨. \n\n\n## 10.6.3 ì„¸ì…˜ì— ì •ë³´ë¥¼ ì €ì¥í•˜ê³  ì½ëŠ” ì„¸ì…˜ ì‹œë¦¬ì–¼ë¼ì´ì € êµ¬í˜„ \n### (1) request.isAuthenticated() í•¨ìˆ˜ê°€ ì„¸ì…˜ì—ì„œ ì •ë³´ë¥¼ ì½ì–´ì˜´. \n\n```ts\nimport { Injectable } from \"@nestjs/common\";\nimport { PassportSerializer } from \"@nestjs/passport\";\n// userService ì£¼ì… -> ìœ ì €ì •ë³´ë¥¼ ê²€ì¦ \nimport { UserService } from \"src/user/user.service\";\n\n@Injectable()\nexport class SessionSerializer extends PassportSerializer {\n    constructor(private userService: UserService){\n        super();\n    }\n    // ì„¸ì…˜ì— ìœ ì €ì˜ ì´ë©”ì¼ ì •ë³´ ì €ì¥ \n    serializeUser(user: any, done: (err:Error, user:any) => void):any {\n        done(null,user.email) // ì„¸ì…˜ì— ì €ì¥í•  ì •ë³´ \n    }\n    // ì„¸ì…˜ì—ì„œ ì •ë³´ë¥¼ êº¼ë‚´ì˜¬ë–„ ì‚¬ìš© \n    async deserializeUser(\n        payload: any,\n        done: (err: Error, payload: any) => void,\n    ): Promise<any> {\n        const user = await this.userService.getUser(payload)\n        // ìœ ì € ì •ë³´ê°€ ì—†ëŠ”ê²½ìš° done()í•¨ìˆ˜ì— ì—ëŸ¬ ì „ë‹¬\n        if(!user) {\n            done(new Error('No User'), null)\n            return \n        }\n        const { password, ...userInfo} = user\n        done(null,userInfo)\n    }\n}\n```\n1. SessionSerializer :  ë¡œê·¸ì¸ ì„±ê³µí›„ ì‚¬ìš©ìì •ë³´ë¥¼ ì„¸ì…˜ì— ì €ì¥. ì´ë©”ì¼(ìµœì†Œí•œì˜ ì •ë³´)ë§Œ ì¶”ì¶œí•˜ì—¬ ì„¸ì…˜ì— ì €ì¥. ì´í›„ ìš”ì²­ì—ì„œ ì„¸ì…˜ì •ë³´ë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ë³µì›í•¨. \nserializeUser í•¨ìˆ˜ê°€ ì´ë©”ì¼ì„ ì„¸ì…˜ì— ì €ì¥í•˜ëŠ” ì‘ì—… ì™„ë£Œí›„ ê·¸ê²°ê³¼ë¥¼ Passport ì— ì•Œë¦¼. \nuser ì •ë³´ëŠ” LocalAuthGuard ì˜ canActive() ë©”ì„œë“œ ì˜ super.logIn(request)ë¥¼ í˜¸ì¶œ í• ë•Œ ë‚´ë¶€ì ìœ¼ë¡œ requestì— ìˆëŠ” user ì •ë³´ë¥¼ êº¼ë‚´ì„œ ì „ë‹¬í•˜ë©´ì„œ serializeUser ì‹¤í–‰\n\n2. done(err:Error, user :any): Passport.js ì—ì„œ ë¹„ë™ê¸° ì‘ì—…ì˜ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ì½œë°± , err ëŠ” Error íƒ€ì…ì˜ ê°ì²´ì„. ê²°ê³¼ void ì´ë¯€ë¡œ done ì€ ì–´ë–¤ ê°’ë„ ë°˜í™˜ í•˜ì§€ ì•ŠìŒ. \n   \n3. (user: any ..)\n    : user ëŠ” ë§¤ê°œë³€ìˆ˜ ì´ë¦„. ë¡œê·¸ì¸ì „ëµ( local,google,facebook) ì„±ê³µì‹œ ì „ë‹¬í•´ì£¼ëŠ” ì‚¬ìš©ì ì •ë³´ë¥¼ ì˜ë¯¸í•¨!! LocalAuthGuard ì‚¬ìš©ì‹œ valildateUser ë©”ì†Œë“œì—ì„œ ë°˜í™˜ëœ ìœ ì €ì •ë³´ê°€ serializeUser í•¨ìˆ˜ì˜ userì¸ìë¡œ ì „ë‹¬ë¨. \n\n5. getPassportInstance() : íŒ¨ìŠ¤í¬íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ì ¸ì˜´, íŒ¨ìŠ¤í¬íŠ¸ ì¸ìŠ¤í„´ìŠ¤ì˜ ë°ì´í„°ê°€ í•„ìš”í•œ ê²½ìš° ì‚¬ìš© \n\n6. deserializeUser() : ì¸ì¦ë˜ì—ˆëŠ”ì§€ ì„¸ì…˜ì— ìˆëŠ” ì •ë³´ë¡œ ê²€ì¦í• ë•Œ \n payload(ì„¸ì…˜ì—ì„œ êº¼ë‚´ì˜¨ê°’.ì „ë‹¬ë˜ëŠ” ë°ì´í„°ì˜ í•µì‹¬ ë¶€ë¶„ ) :  deserializeUser í•¨ìˆ˜ì—ì„œ ì„¸ì…˜ì— ì €ì¥ëœ ì‚¬ìš©ì ì‹ë³„ ì •ë³´(ì´ë©”ì¼)ë¥¼ ì „ë‹¬ ë°›ì•„ í•´ë‹¹ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ë³µì›í•˜ëŠ”ë° ì‚¬ìš©í•˜ëŠ” ê°’. \n\n<img src=\"https://blog.kakaocdn.net/dn/bChuC6/btsL2cs27U8/c8ErD5kTROSImCv9xBdDQ0/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/bChuC6/btsL2cs27U8/c8ErD5kTROSImCv9xBdDQ0/img.webp\" data-origin-width=\"744\" data-origin-height=\"468\" data-is-animation=\"false\" width=\"742\" height=\"467\">\n\n\n## 10.6.4 email,password ì¸ì¦ ë¡œì§ì´ ìˆëŠ” LocalStrategy íŒŒì¼ ì‘ì„± \n\n- ì¸ì¦ ë°©ë²•ì´ ë‹¤ì–‘í•¨. íŒ¨ìŠ¤í¬íŠ¸ì—ì„œ strategy(ì¸ì¦ì „ëµ) ì´ë¼ëŠ” ë³„ê°œì˜ íŒ¨í‚¤ì§€ë¡œ ë¶„ë¦¬í•´ ë‹´ìŒ. \n- id, password ë¡œ ì¸ì¦í•˜ëŠ” ê¸°ëŠ¥ì€ passport-local íŒ¨í‚¤ì§€ì—ì„œ ì œê³µí•¨. \n\n|ì¸ì¦ë°©ë²•|íŒ¨í‚¤ì§€|ì„¤ëª…|\n|--|--|--|\n|Local|passport-local|ìœ ì €ëª…, íŒ¨ìŠ¤ì›Œë“œë¥¼ ì‚¬ìš©|\n|OAuth|passport-oauth|êµ¬ê¸€,í˜ì´ìŠ¤ë¶ ë“± ì™¸ë¶€ ì„œë¹„ìŠ¤ì—ì„œ ì¸ì¦|\n|SAML|passport-saml|SAML ì‹ ì›ì œê³µì‚¬ì—ì„œ ì¸ì¦, OneLogin, Okta|\n|JWT|passport-jwt|JSON web token ì¸ì¦|\n|AWS Cognito|passport-cognito|AWS Cognito user pool ì¸ì¦|\n|LDAP|passport-ldapauth|LDAP ë””ë ‰í„°ë¦¬ ì‚¬ìš© |\n\n\n### (1) email, password ì¸ì¦ ë¡œì§ì´ ìˆëŠ” localStrategy íŒŒì¼ ì‘ì„± \n\n>//auth/local.strategy.ts\n```ts\n//auth/local.strategy.ts\n\nimport { Injectable } from \"@nestjs/common\";\nimport { PassportStrategy } from \"@nestjs/passport\";\nimport { Strategy } from \"passport-local\";\nimport { AuthService } from \"./auth.service\";\n\n@Injectable()\nexport class LocalStrategy extends PassportStrategy(Strategy) {\n    // 1. PassportStrategy ë¯¹ìŠ¤ ì¸ \n    constructor( private authService: AuthService) {\n        // ê¸°ë³¸ê°’ì´ username ì´ë¯€ë¡œ email ë¡œ ë³€ê²½í•¨. \n        super({usernameField :'email'})\n    }\n    // ìœ ì € ì •ë³´ì˜ ìœ íš¨ì„± ê²€ì¦ \n    async validate(email: string, password: string) : Promise<any> {\n        \n        const user = await this.authService.validateUser(email,password)\n        \n        if (!user) {\n            return null // null -> 404 ì—ëŸ¬ \n        }\n        return user  // user ì •ë³´ ë°˜í™˜ \n    }\n}\n```\n- PassportStrategy(Strategy) : ë¯¹ìŠ¤ì¸ \n- ì»´í¬ëŠ”íŠ¸ë¥¼ ì¬ì‚¬ìš©í•  ë•Œ ìƒì†ì„ ë§ì´ ì‚¬ìš©í•˜ì§€ë§Œ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ëª¨ë“ ê²ƒì„ ì¬ì‚¬ìš©í•´ì•¼í•˜ëŠ” ë¶ˆí¸í•¨. í´ë˜ìŠ¤ì˜ ì¼ë¶€ë§Œ í™•ì¥í•˜ê³  ì‹¶ì„ ë•ŒëŠ” ë¯¹ìŠ¤ì¸ ì„ ì‚¬ìš© \n>ğŸ¤” ë¯¹ìŠ¤ì¸(mixin) / íŠ¸ë ˆì‡(trait)\n>í´ë˜ìŠ¤ì— ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´, í•„ìš”í•œ ë©”ì„œë“œë¥¼ ê°€ì§€ê³  ìˆëŠ” ì‘ì€ í´ë˜ìŠ¤ë“¤ì„ ê²°í•©í•´ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ë°©ë²• \n\n- local-strategy ì—ëŠ” ì¸ì¦ì‹œ ì‚¬ìš©í•˜ëŠ” í•„ë“œëª…ì´ username, password ë¡œ ì •í•´ì ¸ìˆìœ¼ë¯€ë¡œ usernameField ì´ë¦„ì„ email ë¡œ ë°”ê¾¸ì–´ì¤Œ. \n- validate() ë©”ì„œë“œì—ì„œëŠ” ì „ë‹¬í•œ emailê³¼ password ê°€ ì˜¬ë°”ë¥¸ì§€ ê²€ì¦í•¨.(ì´ë¯¸ ìˆëŠ” authSErvice ì˜ validateUser() ì‚¬ìš© )\n\n## 10.6.5 auth.module.ts ì— ì„¤ì • ì¶”ê°€ \n### ë§Œë“¤ì–´ë‘” LocalStrategy, SessionSerializer ë¥¼ ë‹¤ë¥¸ í´ë˜ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ë„ë¡ í”„ë¡œë°”ì´ë” ë“±ë¡, passportModuleì— ì„¸ì…˜ì„ ì¶”ê°€ ë“±ë¡ \n> // auth.module.ts\n```ts\n// Passport, serializer , local strategy ì¶”ê°€ \nimport { PassportModule } from '@nestjs/passport';\nimport { SessionSerializer } from './session.serializer';\nimport { LocalStrategy } from './local.strategy';\n\nconsole.log(chalk.red('AuthModule Start[[[ì¸ì¦]]]]'))\n@Module({\n  imports: [\n    UserModule,\n    PassportModule.register({session: true}),\n  ],\n  providers: [\n    AuthService,\n    LocalStrategy,\n    SessionSerializer\n  ],\n  controllers: [AuthController]\n})\n```\n- PassportModule ì˜ ê¸°ë³¸ì„¤ì •ì€ ì„¸ì…˜ ì„¤ì •ì´ false ë¡œ ë˜ì–´ìˆì–´ì„œ true ë¡œ ì„¤ì •. \n- LocalStrategy ,SessionSerializer í”„ë¡œë°”ì´ë” ë“±ë¡ í•„ìš” ë‹¤ë¥¸ë°ì„œ ì£¼ì…í•˜ì§€ ì•Šì•„ë„ í”„ë¡œë°”ì´ë” ë“±ë¡ì•ˆí•˜ë©´ í´ë˜ìŠ¤ë¥¼ ì°¾ì§€ ëª»í•´ ì—ëŸ¬ë‚¨. \n\n\n## 10.6.6. í…ŒìŠ¤íŠ¸ \n>  // auth.controller.ts \n```ts\n// ê°€ë“œ ì‚¬ìš© ì„í¬íŠ¸ \nimport { AuthenticatedGuard, LocalAuthGuard, LoginGuard } from './auth.guard';\n\n    // Login 3. ê°€ë“œ, ì„¸ì…˜, ì¿ í‚¤ ì‚¬ìš© \n    @UseGuards()\n    @Post('login3')\n    login3(@Request() req ) {\n        return req.user\n    }\n\n    @UseGuards(AuthenticatedGuard)\n    @Get('test-guard2')\n    testGuardWithSession(@Request() req){\n        return req.user\n    }\n}\n```\n\n```bash\n### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ê¸°ë¡ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon2025!\"\n    }' \\\n    -c cookies.txt \\\n    http://localhost:3000/auth/login3\n```\n- í‹€ë¦° íŒ¨ìŠ¤ì›Œë“œë¡œ í•˜ë©´ 401 ì—ëŸ¬ê°€ ë‚œë‹¤. (auth.service validateUser() ë™ì‘ )\n- ì¸ì¦ì´ ì„±ê³µí•˜ë©´ ìœ ì €ì •ë³´ê°€ ë‚˜ì˜¨ë‹¤. \n- ì„œë²„ ì¬ì‹œì‘ í•˜ë©´ ì„¸ì…˜ì€ ì´ˆê¸°í™” ë¨. \n\n## 10.6.7 ë¡œê·¸ì¸ê³¼ ì„¸ì…˜ ì €ì¥ê¹Œì§€ ìˆœì„œ \n\n<img src=\"https://blog.kakaocdn.net/dn/dTvf5x/btsL2AHflrI/SdIAQKyzihnS2cv1dreRsk/img.jpg\" data-mce-src=\"https://blog.kakaocdn.net/dn/dTvf5x/btsL2AHflrI/SdIAQKyzihnS2cv1dreRsk/img.jpg\" data-origin-width=\"958\" data-origin-height=\"556\" data-is-animation=\"false\" width=\"763\" height=\"443\">"
            ],
            "outputs": []
        },
        {
            "language": "powershell",
            "source": [
                "### USER login  ì¿ í‚¤ ì¸ì¦ test\ncurl -X GET -b cookies.txt http://localhost:3000/auth/test-guard2"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   108  100   108    0     0      0      0 --:--:-- --:--:-- --:--:--     0 0     0  19230      0 --:--:-- --:--:-- --:--:-- 21600",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"createdDt\":\"2025-01-25T06:51:03.000Z\",\"id\":6,\"email\":\"test1@grkcon.com\",\"username\":\"test1\",\"role\":\"admin\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ê¸°ë¡ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon20225!\"\n    }' \\\n    -c cookies.txt \\\n    http://localhost:3000/auth/login3\n"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   142  100    73  100    69    956      0 --:--:-- --:--:-- --:--:--     0 904 --:--:-- --:--:-- --:--:--  1868",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"statusCode\":401,\"message\":\"ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "markdown",
            "source": [
                "# ETL ì„ ìœ„í•œ DBì„¤ê³„\n\nETL ì„ í™œìš©í•œ ë°ì´í„° ë§ˆíŠ¸ì˜ë°ì´í„°ëŠ” ë°ì´í„°ë¥¼ ì‰½ê²Œ ì‹œê°í™”í•˜ê²Œ ë„ì™€ì¤Œ. \n\n\npostgres ëŠ” nosql ë„ ë˜ê³  sql ë„ ëœë‹¤. ê³ ê¸‰ sql ê¸°ëŠ¥ì„ ë¬´ë£Œë¡œ ì‚¬ìš©ê°€ëŠ¥í•˜ë‹¤.\n\ntypeORM ê³¼ postgres ë¥¼ ì—°ë™í•˜ê³  etl ì´ ê°€ëŠ¥í•˜ë„ë¡ ì„¸íŒ…í•˜ì. \n\n```bash\nnpm install --save @nestjs/typeorm typeorm pg psql\n\n```\n> typeorm.config.ts \n```TS\nimport { TypeOrmModuelOptions } from @nestjs/typeorm\n\nexport const typeOrmConfig: TypeOrmModuleOptions = {\n    type : 'postgres',\n    host : localhost',\n    port : 5432,\n    username: 'postgres',\n    password: 'qwe123',\n    database: 'board-app',\n    entities: [__dirname _ '../../~ entity.ts],\n    synchronize: true\n}\n```\n> app.module.ts \n```TS\nimport {Module} from '@nestjs/common'\nimport { TypeOrmModule } from '@nestjs.typeorm'\nimport {typeOrmConfig } from './configs/typeorm.config'\n\n@Module ({\n    imports[TypeOrmModule.forRoot(typeOrmConfig), ]\n})\n```\n\n\nì°¸ê³  \n1. [2025ë…„ì— ë”°ë¼í•  ìˆ˜ ìˆëŠ” 10ê°€ì§€ MongoDB ETL ë„êµ¬](https://airbyte.com/top-etl-tools-for-sources/mongodb)\n\n2. [Node.jsë¥¼ ìœ„í•œ ìµœê³ ì˜ 5ê°€ì§€ ETL ë„êµ¬ | ì˜¤í”ˆ ì†ŒìŠ¤ Node.js ETL ë„êµ¬](https://blog.panoply.io/5-top-level-etl-tools-for-node.js-and-2-paid-etls)\n\n3. [PostgreSQLì˜ ì°¨ë³„í™”ëœ ê¸°ëŠ¥ê³¼ MySQLê³¼ì˜ ì°¨ì´](https://www.elancer.co.kr/blog/detail/737)\n\n4. [ë”°ë¼í•˜ë©´ì„œ ë°°ìš°ëŠ” NestJS #4 - TypeORM, PostgreSQL](https://velog.io/@jinas1004/%EB%94%B0%EB%9D%BC%ED%95%98%EB%A9%B4%EC%84%9C-%EB%B0%B0%EC%9A%B0%EB%8A%94-NestJS-4-TypeORM-PostgreSQL)"
            ],
            "outputs": []
        },
        {
            "language": "typescript",
            "source": [
                "// auth/aut.test.ts\nconst data = {\n    email: \"test1@grkcon.com\",\n    password: \"grkcon2025!\"\n  };\n  \n  fetch(\"http://localhost:3000/auth/login\", {\n      method: \"POST\",\n      headers: {\n          \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(data),\n  })\n  .then((response) => {\n       const setCookieHeaders = [];\n       const cookies = [];\n       \n       response.headers.forEach((value, key) => {\n           if (key.toLowerCase() === \"set-cookie\") {\n              setCookieHeaders.push(value);\n               const parsedCookies = value.split(';').reduce((acc, cookie) => {\n                  const [name, value] = cookie.trim().split('=');\n                  if (name && value) {\n                      acc[name] = value;\n                  }\n                  return acc;\n              }, {});\n              cookies.push(parsedCookies)\n           }\n       });\n    \n       console.log(\"Set-Cookie í—¤ë”ë“¤:\", setCookieHeaders);\n       console.log(\"íŒŒì‹± ëœ ì¿ í‚¤ë“¤:\", cookies)\n    \n    \n    return response.json();\n  })\n  .then((result) => console.log(\"ì‘ë‹µ ê²°ê³¼:\", result))\n  .catch((error) => console.error(\"ì˜¤ë¥˜ ë°œìƒ:\", error));"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "Set-Cookie í—¤ë”ë“¤: [",
                                "  'login=%7B%22createdDt%22%3A%222025-01-25T06%3A51%3A03.000Z%22%2C%22id%22%3A6%2C%22email%22%3A%22test1%40grkcon.com%22%2C%22username%22%3A%22test1%22%2C%22role%22%3A%22admin%22%7D; Max-Age=86400; Path=/; Expires=Sun, 26 Jan 2025 06:51:54 GMT'",
                                "]",
                                "ì‘ë‹µ ê²°ê³¼: { message: 'login success' }",
                                ""
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ê¸°ë¡ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon2025!\"\n    }' \\\n    -c cookies.txt \\\n    http://localhost:3000/auth/login\n\n    "
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100    95  100    27  100    68    210    529 --:--:-- --:--:-- --:--:--     0 --:--:-- --:--:--   742",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"message\":\"login success\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER login ê°€ë“œ í…ŒìŠ¤íŠ¸ ( cookie ì½ì–´ì„œ login2 ì¿ í‚¤ í™•ì¸ )\ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\n    \"email\":\"test1@grkcon.com\",\n    \"password\":\"grkcon2025!\"\n    }' \\\n    -b cookies.txt \\\n    http://localhost:3000/auth/login2"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100    96  100    28  100     0      0      0 --:--:-- --:--:-- --:--:--     0   68  14917  36228 --:--:-- --:--:-- --:--:-- 96000",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"message\":\"login2 success\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER login  ì¿ í‚¤ ì¸ì¦ test\ncurl -X GET -b cookies.txt http://localhost:3000/auth/test-guard"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100    46  100    46    0     0      0      0 --:--:-- --:--:-- --:--:--     0 26869      0 --:--:-- --:--:-- --:--:-- 46000",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "ë¡œê·¸ì¸ ëœ ë–„ë§Œ ì´ ê¸€ì´ ë³´ì…ë‹ˆë‹¤. "
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "## AuthControll check \ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"username\" :\"test1\",\n    \"password\": \"grkcon2025!\",\n    \"email\":\"test1@grkcon.com\",\n    \"role\":\"admin\"\n    }' \\\n    http://localhost:3000/auth/register"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   217  100   108  100   109   1640   1655 --:--:-- --:--:-- --:--:--     0--:--:-- --:--:--  3338",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"username\":\"test1\",\"email\":\"test1@grkcon.com\",\"role\":\"admin\",\"id\":6,\"createdDt\":\"2025-01-25T06:51:03.000Z\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER login test\n curl -v -X POST \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\n     \"email\":\"forre2@grkcon.com\",\n     \"password\":\"grkcon2025!\"\n     }' \\\n     -b cookies.txt \\\n     http://localhost:3000/auth/login"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "Note: Unnecessary use of -X or --request, POST is already inferred.",
                                "* Host localhost:3000 was resolved.",
                                "* IPv6: ::1",
                                "* IPv4: 127.0.0.1",
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying [::1]:3000...",
                                "* Connected to localhost (::1) port 3000",
                                "> POST /auth/login HTTP/1.1",
                                "> Host: localhost:3000",
                                "> User-Agent: curl/8.5.0",
                                "> Accept: */*",
                                "> Content-Type: application/json",
                                "> Content-Length: 72",
                                "> ",
                                "} [72 bytes data]",
                                "< HTTP/1.1 201 Created",
                                "< X-Powered-By: Express",
                                "< Content-Type: application/json; charset=utf-8",
                                "< Content-Length: 27",
                                "< ETag: W/\"1b-1kZjyyqCNo1Oj/t1Y5EmCqBR99s\"",
                                "< Date: Sat, 25 Jan 2025 06:28:16 GMT",
                                "< Connection: keep-alive",
                                "< Keep-Alive: timeout=5",
                                "< ",
                                "{ [27 bytes data]",
                                "100    99  100    27  100    72   4092  10914 --:--:-- --:--:-- --:--:-- 16500",
                                "* Connection #0 to host localhost left intact",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"message\":\"login success\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER create test\n curl -X POST \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"username\" :\"Forre2\",\n     \"password\": \"grkcon2025!\",\n     \"email\":\"forre2@grkcon.com\",\n     \"role\":\"admin\"\n     }' \\\n     http://localhost:3000/user/create"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   250  100   135  100   115  16720      0 --:--:-- --:--:-- --:--:--     014243 --:--:-- --:--:-- --:--:-- 31250",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"username\":\"Forre2\",\"password\":\"grkcon2025!\",\"email\":\"forre2@grkcon.com\",\"role\":\"admin\",\"id\":4,\"createdDt\":\"2025-01-25T06:18:31.000Z\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### User get test\ncurl -X GET http://localhost:3000/user/getUser/forre@grkcon.com\n"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   132  100   132    0     0  17722      0 --:--:-- --:--:-- --:--:--     0      0 --:--:-- --:--:-- --:--:-- 18857",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"createdDt\":\"2025-01-23T03:15:14.000Z\",\"id\":1,\"email\":\"forre@grkcon.com\",\"password\":\"grkcon2025!\",\"username\":\"Forre\",\"role\":\"user\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### Update User \ncurl -X PUT \\\n     -H \"Content-Type: application/json\" \\\n     -d '{\"username\" :\"Forre\",\n     \"password\": \"grkcon2025!\",\n     \"role\":\"user\"\n     }' \\\n     http://localhost:3000/user/update/forre@grkcon.com\n"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100    79    0     0  100    79      0      0 --:--:-- --:--:-- --:--:--     04638 --:--:-- --:--:-- --:--:--  4647",
                                ""
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "powershell",
            "source": [
                "### USER create test wrong input error \ncurl -X POST \\\n    -H \"Content-Type: application/json\" \\\n    -d '{\"username\" :\"test\",\n    \"password\": \"grkcon2025!\",\n    \"email\":\"test@email.com\",\n    \"role\":\"admin\"\n    }' \\\n    http://localhost:3000/user/create"
            ],
            "outputs": [
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stderr",
                            "value": [
                                "  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current",
                                "                                 Dload  Upload   Total   Spent    Left  Speed",
                                "100   236    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0100   130  100   106  11185   9120 --:--:-- --:--:-- --:--:-- 21454",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "items": [
                        {
                            "mime": "application/vnd.code.notebook.stdout",
                            "value": [
                                "{\"username\":\"test\",\"password\":\"grkcon2025!\",\"email\":\"test@email.com\",\"role\":\"admin\",\"id\":5,\"createdDt\":\"2025-01-25T06:50:35.000Z\"}"
                            ]
                        }
                    ]
                }
            ]
        },
        {
            "language": "markdown",
            "source": [
                "# 11. OAuth ë¥¼ ì‚¬ìš©í•œ êµ¬ê¸€ ë¡œê·¸ì¸ ì¸ì¦ \n\n- OAuth(open Authorization ) ê°œë°©í˜• ì¸ê°€ í‘œì¤€ \n- OAuth ëŠ” ì¸ì¦ì´ ì•„ë‹ˆë¼ ì¸ê°€ì˜ ê´€ì ì—ì„œ ë³´ì•„ì•¼í•¨. \n- ì†Œì…œ ë¡œê·¸ì¸ í›„ íŒì—…ì´ ëœ¨ë©´ì„œ ê¶Œí•œì„ ìš”ì²­í•˜ëŠ” í™”ë©´ \n- OAuth 1.0, 2.0, 2.1 ì¤‘ 2.0 ì„ ê°€ì¥ ë§ì´ ì‚¬ìš© \n\nì¸ì¦: ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ ìê²©ì´ ìˆëŠ”ì§€ ê²€ì¦í•˜ëŠ” ê³¼ì • ,OAuth ì—ì„œ ë¦¬ì†ŒìŠ¤ëŠ” ë³´í˜¸ëœ ì •ë³´ë¥¼ ì˜ë¯¸í•¨. \nì¸ê°€ : ìì›ì— ì ‘ê·¼í•  ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê³¼ì •. ì¸ê°€ê°€ ì™„ë£Œë˜ë©´ ë¦¬ì†ŒìŠ¤ì˜ ì ‘ê·¼ ê¶Œí•œ ì •ë³´ê°€ ìˆëŠ” ì—‘ì„¸ìŠ¤ í† í°ì„ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë³´ë‚´ì¤Œ. \nì—‘ì„¸ìŠ¤ í† í° : ë¦¬ì†ŒìŠ¤ ì„œë²„ì—ì„œ ë¦¬ì†ŒìŠ¤ ì†Œìœ ìì˜ ë³´í˜¸ëœ ì •ë³´ë¥¼ íšë“ í• ë–„ ì‚¬ìš©í•˜ëŠ” ë§Œë£Œê¸°ê°„ì´ ìˆëŠ” í† í° \në¦¬í”„ë ˆì‹œ í† í° : ì—‘ì„¸ìŠ¤ í† í°ì´ ë§Œë£Œë˜ì—ˆì„ë–„ ê°±ì‹ í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©í•˜ëŠ” í† í°. ì•¡ì„¸ìŠ¤ í† í°ë³´ë‹¤ ë§Œë£Œê¸°ê°„ì„ ê¸¸ê²Œ ê°€ì ¸ê° \në¦¬ì†ŒìŠ¤ ì†Œìœ ì : ë¦¬ì†ŒìŠ¤ëŠ” ì‚¬ìš©ìì˜ ë³´í˜¸ëœ ì •ë³´ë¥¼ ë§í•˜ë©° ì´ëŸ° ì •ë³´ì— ì ‘ê·¼í•˜ë„ë¡ ìê²©ì„ ë¶€ì—¬í•˜ëŠ” ì‚¬ëŒ. OAuth ì—ì„œëŠ” ì‚¬ìš©ìê°€ ë¦¬ì†ŒìŠ¤ ì†Œìœ ìë‹¤ ë¼ê³  ìƒê°í•˜ë©´ ë¨. \ní´ë¼ì´ì–¸íŠ¸ : ë¦¬ì†ŒìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ê³  ì ‘ê·¼ì„ ìš”ì²­í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ \në¦¬ì†ŒìŠ¤ ì„œë²„  : ì‚¬ìš©ìì˜ ë³´í˜¸ëœ ìì›ì„ ê°€ì§€ê³  ìˆëŠ” ì„œë²„ \nì¸ê°€ ì„œë²„ : ì¸ì¦ ì¸ê°€ë¥¼ ìˆ˜í–‰ í•˜ëŠ” ì„œë²„ë¡œ í´ë¼ì´ì–¸íŠ¸ì˜ ì ‘ê·¼ ìê²©ì„ í™•ì¸í•˜ê³  ì•¡ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰í•´ ê¶Œí•œì„ ë¶€ì—¬í•¨. \n\n- ì¸ê°€ ì„œë²„ì™€ ë¦¬ì†ŒìŠ¤ ì„œë²„ì˜ ì¡°í•© ì„ OAuth2 í”„ë¡œë°”ì´ë”ë¼ê³  ë¶€ë¦„. \n\n## 11.1.1 OAuth í”„ë¡œí† ì½œ íë¦„ \n<img src=\"https://blog.kakaocdn.net/dn/cNHy3B/btsL2a99wzV/81K65QqS0Hy4pxHlAkwlP0/img.jpg\" data-mce-src=\"https://blog.kakaocdn.net/dn/cNHy3B/btsL2a99wzV/81K65QqS0Hy4pxHlAkwlP0/img.jpg\" data-origin-width=\"788\" data-origin-height=\"552\" data-is-animation=\"false\" width=\"757\" height=\"530\">\n\n- ì¸ì¦ì½”ë“œ(Authorization code) ì‚¬ìš© \n- ì•”ë¬µì  ë°©ë²• (Implicit)\n- ë¦¬ì†ŒìŠ¤ ì†Œìœ ìì˜ ì•”í˜¸ ìê²©ì¦ëª… (Resource Owner Password Credential)\n- í´ë¼ì´ì–¸íŠ¸ ìê²©ì¦ëª… (Client Credentials)\n\n## 11.1.2  ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œ í–‰ íë¦„. \nì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œì‹œ ë¦¬í”„ë ˆì‹œ í† í°ìœ¼ë¡œ ì¬ë°œí—¹ \n\n\n\n# 11.2 êµ¬ê¸€ OAuth ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¤€ë¹„ \n\n## 11.2.1 êµ¬ê¸€ í´ë¼ìš°ë“œ í”„ë¡œì íŠ¸ ìƒì„±\n\n### (1) í”„ë¡œì íŠ¸ ìƒì„± https://console.cloud.google.com ì ‘ì†  >  í”„ë¡œì íŠ¸ ì„ íƒ > ìƒˆí”„ë¡œì íŠ¸ > í”„ë¡œì íŠ¸ ì´ë¦„ grk-research-oauth \n\n<img src=\"https://blog.kakaocdn.net/dn/IsB3s/btsL185L9pa/6Wdnbk0opn34Zo1DAfhdhk/img.webp\" data-is-animation=\"false\" data-origin-width=\"1708\" data-origin-height=\"740\" data-filename=\"Screenshot 2025-01-27 at 4.52.51â€¯PM.webp\" width=\"786\" height=\"341\">\n\n## 11.2.2 Oauth ë™ì˜ í™”ë©´ ìƒì„± \n### (1) ìƒì„± í”„ë¡œì íŠ¸ ì„ íƒ > ì™¼ìª½ íƒ­ [api ë° ì„œë¹„ìŠ¤ ] í´ë¦­ > [Oath ë™ì˜ í™”ë©´ í´ë¦­ ]\n<img src=\"https://blog.kakaocdn.net/dn/dqX54G/btsL3AmufAj/sST7Dgt6JmPlrKwMNlKlTK/img.webp\" data-is-animation=\"false\" data-origin-width=\"1698\" data-origin-height=\"1348\" data-filename=\"Screenshot 2025-01-27 at 5.01.18â€¯PM.webp\" width=\"777\" height=\"617\">\n\nì•±ì •ë³´ > ì•±ì´ë¦„ 'grk-research-platform' > ì‚¬ìš©ì ì§€ì› ì´ë©”ì¼ forre@grkcon.com > ì•±ë¡œê³  ì¦‰ì„ ì œì‘ >  ì•± ë„ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ í™ˆí˜ì´ì§€ http://forrestest.site > \n<img src=\"https://blog.kakaocdn.net/dn/bNkjEK/btsL1A9ezyy/PoSAshsW1gDywltZR9FKdK/img.webp\" data-is-animation=\"false\" data-origin-width=\"1666\" data-origin-height=\"876\" data-filename=\"Screenshot 2025-01-27 at 6.33.07â€¯PM.webp\" width=\"755\" height=\"397\">\n\n-> ì´ì„¤ì •ì€ ë‚˜ì¤‘ì— grkconplatform ì‚¬ì´íŠ¸ê°€ ì •í•´ì§€ë©´ ë°”ê¾¸ì–´ì•¼í•œë‹¤.  > ê°œë°œì ì—°ë½ì²˜ ì •ë³´ ì…ë ¥ > ì €ì¥í›„ ê³„ì† ë²„íŠ¼ í´ë¦­ > í…ŒìŠ¤íŠ¸ì‚¬ìš©ì -ì €ì¥í›„ ê³„ì† > ëŒ€ì‹œë³´ë“œ ëŒì•„ê°€ê¸° \n\n## 11.2.3 OAuth í´ë¼ì´ì–¸íŠ¸ì˜ idì™€ ë¹„ë°€ë²ˆí˜¸ ìƒì„± \n\n###  (1) ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > ì‚¬ìš©ì ì¸ì¦ì •ë³´ ë§Œë“¤ê¸° > Oauth í´ë¼ì´ì–¸íŠ¸ id í´ë¦­ > ì¸ì¦ ì •ë³´ ì„¤ì • í™”ë©´ ì´ë™ \n<img src=\"https://blog.kakaocdn.net/dn/674Kl/btsL3OZfJ5y/TzKmj6a3wRbIrKn4tyllFk/img.webp\" data-is-animation=\"false\" data-origin-width=\"1108\" data-origin-height=\"1336\" data-filename=\"Screenshot 2025-01-27 at 6.36.00â€¯PM.webp\" width=\"744\" height=\"897\">\n\n### (2) í´ë¼ì´ì–¸íŠ¸ ìƒì„±, ë„ë©”ì¸ ì¶”ê°€ í›„ í´ë¼ì´ì–¸íŠ¸ ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸ ì €ì¥..ë§¤ìš° ë³´ì•ˆì¤‘ìš”!\n<img src=\"https://blog.kakaocdn.net/dn/PnRmR/btsL1HgwTyH/O10TBaD8bd7ffCCM7lkd60/img.webp\" data-is-animation=\"false\" data-origin-width=\"1042\" data-origin-height=\"1082\" data-filename=\"Screenshot 2025-01-27 at 6.36.21â€¯PM.webp\" width=\"742\" height=\"770\">\n\n# 11.3 êµ¬ê¸€ OAuth êµ¬í˜„ ìˆœì„œ \n\n- êµ¬ê¸€ OAuth  ì´ë©”ì¼ê³¼ í”„ë¡œí•„ ì •ë³´ë¥¼ êµ¬ê¸€ Oauth ìŠ¤íŠ¸ë ˆí‹°ì§€ íŒŒì¼ì˜ validate() ë©”ì„œë“œì—ì„œ ì½œë°±ìœ¼ë¡œ ë°›ìŒ. \n- ì´ë•Œ ë„˜ì–´ì˜¤ëŠ” ë°ì´í„°ëŠ” ì•¡ì„¸ìŠ¤ í† í°, ë¦¬í”„ë˜ì‹œí† í°, í”„ë¡œí•„ ì •ë³´ .\n- í”„ë¡œí•„ì—ëŠ” ì‹ë³„ìë¡œ ì‚¬ìš©ë˜ëŠ” IDê°€ ìˆìœ¼ë©° providerId ë¼ê³  í•¨, name ê°ì²´ ë„ ìˆìŒ. \n\n\n# 11.4 NestJS í™˜ê²½ ì„¤ì • íŒŒì¼ ì¶”ê°€ \n\n```bash\nnpm i @nesetjs/config\n```\n\n\n### (2) .env êµ¬ê¸€ oauth ìš© íŒŒì¼ ìƒì„±, ë° ì„¤ì • \n\ní˜„ì¬ load ì˜µì…˜ì„ ì‚¬ìš©í•´ ì»¤ìŠ¤í…€ ì„¤ì • íŒŒì¼ ì¶”ê°€ ì¤‘ì´ë¯€ë¡œ .env íŒŒì¼ì´ ì•„ë‹ˆë¼ \ndev.ts íŒŒì¼ì—ì„œ ì„¤ì • \n- .gitignore ì— dev.ts íŒŒì¼ ì¶”ê°€ \n\n## 11.5 êµ¬ê¸€ OAuth ìŠ¤íŠ¸ë ˆí‹°ì§€ ìƒì„± \n### (1) ìŠ¤íŠ¸ë ˆí‹°ì§€ ì§€ì› íŒ¨í‚¤ì§€ ì„¤ì¹˜ \n```bash\nnpm i passport-google-oauth20\nnpm i -D @types/passport-google-oauth20\n```\n### (2) google.strategy.ts ìƒì„± \n\n```ts\n// src/auth/google.strategy.ts\n\nimport { Injectable } from \"@nestjs/common\";\nimport { PassportStrategy } from \"@nestjs/passport\";\nimport { Profile, Strategy } from \"passport-google-oauth20\";\nimport { User } from \"src/user/user.entity\";\nimport { UserService } from \"src/user/user.service\";\n\n// Google id, secretì€ Config file ì— ìˆìŒ \nimport { ConfigService } from \"@nestjs/config\";\n\n@Injectable()\n// Passport Strategy ìƒì† \nexport class GoogleStrategy extends PassportStrategy(Strategy) {\n    constructor(\n        private userService: UserService,\n        private configService: ConfigService\n    ) {\n        super({\n            clientID : configService.get<string>('GOOGLE_CLIENT_ID'),\n            clientSecret : configService.get<string>('GOOGLE_CLIENT_SECRET'),\n            callbackURL : 'http://localhost:3000/auth/google',\n            scope : ['email', 'profile']\n        })\n    }\n    async validate(accessToken: string, refreshToken: string, profile: Profile) {\n\n        const {id, name, emails} =profile\n        console.log(accessToken)\n        console.log(refreshToken)\n        const providerId = id\n        const email = emails[0].value\n        console.log(providerId, email, name.familyName, name.givenName)\n        return profile\n    }\n\n}\n```\n- Strategy í´ë˜ìŠ¤ëŠ” ì¸ì¦ì‹œ ì— ì‚¬ìš©í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•˜ëŠ” ë©”ì„œë“œ \n- PassportStrategy ë©”ì„œë“œ validate() ë¥¼ ì¶”ê°€í•  ëª©ì ìœ¼ë¡œ ì‚¬ìš© \n- PassportStrategy ëŠ” NestJS ì—ì„œ íŒ¨ìŠ¤í¬íŠ¸ë¥¼ ã…ìš©í•˜ëŠ” ë°©ë²•ì„ ì¼ì›í™” í•˜ëŠ”ë° ì‚¬ìš©í•˜ëŠ” ë¯¹ìŠ¤ ì¸ ì„. \n- ì¸ì¦ì˜ ìœ íš¨ì„± ê²€ì¦ì‹œ validate() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ê²ƒì´ë¼ëŠ” ê²ƒì„ ì‰½ê²Œ ìœ ì¶” ê°€ëŠ¥. \n- ìƒì„±ìì— userService ìƒì„±í•˜ì§€ë§Œ í˜„ì¬ëŠ” ì‚¬ìš© ì•ˆí•˜ë§ˆ. \n- validate : êµ¬ê¸€ OAuth ì¸ì¦ í›„ ì½œë°± url ì„ ì‹¤í–‰í•˜ê¸° ì „ì— ìœ íš¨ì„± ê²€ì¦í•¨. ì½œë°±ì˜ ë§¤ê°œ ë³€ìˆ˜ë¡œ access_token, refresh_token, profile ì„ ë°›ìŒ. access_token ê³¼ refresh_token ì€ ë”±íˆ í•„ìš”ëŠ” ì—†ìŒ. ìµœì´ˆ ì¸ì¦ì‹œ ìœ ì €ë°ì´í„°ë¥¼ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê¸° ë•Œë¬¸. \n- profile: passport-google-oauth20 ì˜ Profile íƒ€ì… ì¸ìŠ¤í„´ìŠ¤ì„. id, name, emails ì†ì„±ì„ ê°€ì§. \n- id ëŠ” í”„ë¡œë°”ì´ë” ID ë¡œ í•´ë‹¹ í”„ë¡œë°”ì´ë”ì—ì„œ ìœ ì¼í•œê°’, \n### (3) Strategy ëŠ” í”„ë¡œë°”ì´ë”ì´ë¯€ë¡œ ë“±ë¡, auth.module \n\n> auth.moduel.ts\n``` ts\n// Google strategy ë“±ë¡ \nimport { GoogleStrategy } from './google.strategy';\n\n  providers: [\n    AuthService,\n    LocalStrategy,\n    SessionSerializer,\n    GoogleStrategy\n\n  ],\n```\n\n# 11.6 GoogleAuthGuard ìƒì„± \n### (1) auth.guard.ts ì— GoogleAuthGuard í´ë˜ìŠ¤ ì¶”ê°€ \n\n> auth.guard.ts\n```ts\n@Injectable()\n// Google stratagey Guard ìƒì† \nexport class GoogleAuthGuard extends AuthGuard('google'){\n  async canActivate(context: ExecutionContext):  Promise<boolean>  {\n    const result = (await super.canActivate(context)) as boolean\n\n    // context ì—ì„œ request ë¥¼ ì¶”ì¶œ í•¨. \n    const request = context.switchToHttp().getRequest()\n    return result\n  }\n}\n```\n- passport ì˜ Strategy ë¥¼ ì‰½ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤ë¡œ ìƒì„±ìì˜ ë§¤ê°œë³€ìˆ˜ì— ì‚¬ìš©í•  ìŠ¤íŠ¸ë˜í‹°ì§€ ë¬¸ìì—´ë¡œ ë„£ìœ¼ë©´ ë¨. \n- super.canActivate() ë©”ì„œë“œì—ì„œ GoogleStrategy ì˜ validate() ë¥¼ ì‚¬ìš©í•¨. \n- nestJS ì—ì„œëŠ” context ì—ì„œ ë¦¬í€˜ìŠ¤íŠ¸ ê°ì²´ë¥¼ êº¼ë‚¼ìˆ˜ ìˆìŒ. \n\n<img src=\"https://blog.kakaocdn.net/dn/o9eZT/btsL1hWoEjp/4e8iVDN2cUrYNaHvVDnsgK/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/o9eZT/btsL1hWoEjp/4e8iVDN2cUrYNaHvVDnsgK/img.webp\" data-origin-width=\"1122\" data-origin-height=\"652\" data-is-animation=\"false\" width=\"757\" height=\"440\">\n\n# 11.7 ì»¨íŠ¸ë¡¤ëŸ¬ì— í•¸ë“¤ëŸ¬ ë©”ì„œë“œ ì¶”ê°€ \n### (1) ìŠ¤íŠ¸ë ˆí‹°ì§€. ê°€ë“œ ìƒì„± í›„ -> ìœ ì € ìš”ì²­ ë°›ì„ ì»¨í‹€ë¡¤ëŸ¬ ì•ˆì— í•¸ë“¤ëŸ¬ ë§¤ì„œë“œ ì‘ì„± \n> auth.controller.ts\n```ts\n    // Google login \n    @Get('to-google')\n    @UseGuards(GoogleAuthGuard)\n    async googleAuth(@Request() req) {}\n\n    @Get('google')\n    @UseGuards(GoogleAuthGuard)\n    async googleAuthRedirect(@Request() req , @Response() res) {\n        const { user } = req\n        return res.send(user)\n    }\n```\n- GoogleAuthGuard ì„í¬íŠ¸ googleAuth() , googleAuthRedirect() ì—ì„œ ì‚¬ìš© \n  \n\n## 11.7.1 í…ŒìŠ¤íŠ¸ \nhttp://localhost:3000/auth/to-google > ë¨..\n\n\n# 11.8 User ì—”í‹°í‹° íŒŒì¼ ìˆ˜ì • \n### (1) user.entity ì—ì„œ password ê°€ ì—†ì„ë•Œì—ë„ ë°ì´í„°ê°€ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ê³¼ êµ¬ê¸€ ì¸ì¦ì‹œ ì‹ë³„ìì¸ providerID ì¶”ê°€ \n\n> user.entity.ts\n```ts\n    @Column( {nullable: true}) // google ì¸ì¦ì‹œ íŒ¨ìŠ¤ì›Œë“œì— ë¹ˆê°’ í—ˆìš© \n    password: string\n\n   // provider ID : êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì•„ë‹Œê²½ìš° ë¹ˆê°’  \n    @Column({ nullable : true})\n    providerId : string\n}\n```\n\n# 11.9 UserService ì— êµ¬ê¸€ ìœ ì € ê²€ìƒ‰ ë° ì €ì¥ ë©”ì„œë“œ ì¶”ê°€. \n- êµ¬ê¸€ ì¸ì¦ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íšŒì› ê°€ì…ì„ ì‹œì¼œì£¼ëŠ” ë§¤ì„œë“œ ì¶”ê°€ \n- ì´ë¯¸ íšŒì› ì •ë³´ê°€ ì‡ë‹¤ë©´ íšŒì›ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ í•„ìš” \n- êµ¬ê¸€ì€ providerId ë¡œ ì°¾ì§€ë§Œ ìš°ë¦¬ëŠ” ì´ë©”ì¼ì´ íšŒì›ì„ êµ¬ë¶„í•˜ëŠ” ë‹¨ìœ„ ì„. \n- ì´ë©”ì¼ë¡œ ê¸°ì¡´ ê°€ì… ì—¬ë¶€ë¥¼ í™•ì¸í•´ ê°€ì…ë˜ì–´ìˆìœ¼ë©´ ìœ ì €ì •ë³´ ë°˜í™˜, ì•„ë‹ˆë©´ íšŒì›ì •ë³´ë¥¼ ìœ ì € í…Œì´ë¸”ì— ì €ì¥í•˜ëŠ” ì½”ë“œ ì‘ì„± \n\n> user.service.ts\n```ts\n    // Google ì ‘ì† ì‹œ ìœ ì € ê²€ìƒ‰ ë° íšŒì› ê°€ì… \n    async findByEmailOrSave(email, username, providerId): Promise<User> {\n        const foundUser = await this.getUser(email)\n        if (foundUser) {\n            return foundUser\n        }\n        // ê¸°ì¡´ íšŒì›ì´ ì•„ë‹Œê²½ìš° db ì €ì¥ \n        const newUser = await this.userRepository.save({\n            email,\n            username,\n            providerId\n        })\n        return newUser\n    }\n```\n\n# 11.10 GoogleStrategy ì— êµ¬ê¸€ ìœ ì € ì €ì¥í•˜ëŠ” ë©”ì„œë“œ ì ìš© \n### (1) GoogleStrategy ì˜ validate() ë©”ì„œë“œì—ì„œ êµ¬ê¸€ ìœ ì € ì •ë³´ê°€ ìˆë‹¤ë©´ ì •ë³´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¤ê³  ì—†ë‹¤ë©´ ì €ì¥ í•„ìš” findByEmailOrSave ë©”ì„œë“œë¥¼ GoogleStrategyì— ì ìš© , validate() ë©”ì„œë“œì—ì„œ profile ì •ë³´ì˜ id, name, email ì„ db ì— ì €ì¥í•˜ë„ë¡ User ì—”í„°í‹°ì— ë§ì¶° ë„˜ê²¨ì¤Œ . \n\n> google.strategy.ts\n```ts\n // Google ìš© validate\n    async validate(accessToken: string, refreshToken: string, profile: Profile) {\n\n        const {id, name, emails} =profile\n        console.log(accessToken)\n        console.log(refreshToken)\n        const providerId = id\n        const email = emails[0].value\n        console.log(providerId, email, name.familyName, name.givenName)\n\n        // db ìš© User entity í¬ë§· <- userService \n        const user : User =await this.userService.findByEmailOrSave(\n            email,\n            name.familyName + name.givenName,\n            providerId\n        )\n        return user\n    }\n```\n\n# 11.11 GoogleAuthGuardì—ì„œ ì„¸ì…˜ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½ \n### (1) HTTP ìš”ì²­ì‹œë§ˆë‹¤ êµ¬ê¸€ OAuth í†µí•´ì¸ì¦í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ì¿ í‚¤, ì„¸ì…˜ ì‚¬ìš©í•˜ì—¬ ì €ì¥ëœ ë°ì´í„°ë¡œ ì¸ì¦í•˜ë„ë¡ ì½”ë“œ ë³€ê²½ \n\n```ts\n@Injectable()\n// Google stratagey Guard ìƒì† \nexport class GoogleAuthGuard extends AuthGuard('google'){\n  async canActivate(context: ExecutionContext):  Promise<boolean>  {\n    const result = (await super.canActivate(context)) as boolean\n\n    // context ì—ì„œ request ë¥¼ ì¶”ì¶œ í•¨. \n    const request = context.switchToHttp().getRequest()\n    \n    // ì„¸ì…˜ ì‚¬ìš©í•˜ì—¬ ì¸ì¦ ìœ ì§€ \n    await super.logIn(request)\n    return result\n      \n  }\n```\n\nhttp://localhost:3000/auth/to-google\n\n<img src=\"https://blog.kakaocdn.net/dn/cQdOfW/btsL2dMtoBO/niSDurrAfckKSaOYskKygK/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/cQdOfW/btsL2dMtoBO/niSDurrAfckKSaOYskKygK/img.webp\" data-origin-width=\"1198\" data-origin-height=\"912\" data-is-animation=\"false\" width=\"754\" height=\"574\">\n\n<img src=\"https://blog.kakaocdn.net/dn/dQFV1J/btsL1qszdPj/PkX2Bz4tJ1Xf2E9pGy7kuk/img.webp\" data-mce-src=\"https://blog.kakaocdn.net/dn/dQFV1J/btsL1qszdPj/PkX2Bz4tJ1Xf2E9pGy7kuk/img.webp\" data-origin-width=\"948\" data-origin-height=\"566\" data-is-animation=\"false\" width=\"759\" height=\"453\">\n\n<img src=\"https://blog.kakaocdn.net/dn/zkMr2/btsL2l42B4i/FgMZ7eAw2eLkirUY9LUAkK/img.gif\" data-is-animation=\"true\" data-origin-width=\"852\" data-origin-height=\"828\" data-filename=\"grklogin-google.gif\" width=\"746\" height=\"725\">\n\n"
            ],
            "outputs": []
        }
    ]
}